import{PipelineStageName as e,Sort as u}from"../common/constant";import{DbBuildError as c}from"../common/error";import{AggregateRequest as h}from"./AggregateRequest";import{QueryRequest as m}from"./QueryRequest";var l=function(){function r(){this.pipeline=[]}r.prototype.addFields=function(t){this.pushStage(e.addFields,t);return this};r.prototype.count=function(t){this.pushStage(e.count,t);return this};r.prototype.match=function(t){this.pushStage(e.match,t);return this};r.prototype.group=function(t){this.pushStage(e.group,t);return this};r.prototype.project=function(t){this.pushStage(e.project,t);return this};r.prototype.replaceRoot=function(t){this.pushStage(e.replaceRoot,t);return this};r.prototype.sample=function(t){this.pushStage(e.sample,t);return this};r.prototype.lookup=function(t){this.pushStage(e.lookup,t);return this};r.prototype.sort=function(t){this.pushStage(e.sort,t);return this};r.prototype.limit=function(t){this.pushStage(e.limit,t);return this};r.prototype.skip=function(t){this.pushStage(e.skip,t);return this};r.prototype.unwind=function(t){this.pushStage(e.unwind,t);return this};r.prototype.done=function(){return this.pipeline.map(function(t){var i,p;switch(t.name){case e.match:return{$match:new m(t.param).toJSON()};case e.count:case e.sample:case e.lookup:case e.limit:case e.skip:case e.unwind:return i={},i[t.name]=t.param,i;case e.addFields:case e.group:case e.project:case e.replaceRoot:return p={},p[t.name]=new h(t.param).toJSON(),p;case e.sort:return{$sort:Object.keys(t.param).reduce(function(n,a){var o;switch(t.param[a]){case u.DESC:o=-1;break;case u.ASC:o=1;break;case 1:o=1;break;case-1:o=-1;break;default:o=1}n[a]=o;return n},{})};default:{var s=t.name;throw c.invalidParam(s,"\u4E0D\u652F\u6301\u7684 aggregate \u64CD\u4F5C")}}})};r.prototype.pushStage=function(t,i){this.pipeline.push({name:t,param:i})};return r}();export{l as AggregatePipeline};
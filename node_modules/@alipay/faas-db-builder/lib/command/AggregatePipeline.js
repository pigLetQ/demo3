"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.AggregatePipeline=void 0;var constant_1=require("../common/constant");var error_1=require("../common/error");var AggregateRequest_1=require("./AggregateRequest");var QueryRequest_1=require("./QueryRequest");var AggregatePipeline=function(){function t(){this.pipeline=[]}t.prototype.addFields=function(e){this.pushStage(constant_1.PipelineStageName.addFields,e);return this};t.prototype.count=function(e){this.pushStage(constant_1.PipelineStageName.count,e);return this};t.prototype.match=function(e){this.pushStage(constant_1.PipelineStageName.match,e);return this};t.prototype.group=function(e){this.pushStage(constant_1.PipelineStageName.group,e);return this};t.prototype.project=function(e){this.pushStage(constant_1.PipelineStageName.project,e);return this};t.prototype.replaceRoot=function(e){this.pushStage(constant_1.PipelineStageName.replaceRoot,e);return this};t.prototype.sample=function(e){this.pushStage(constant_1.PipelineStageName.sample,e);return this};t.prototype.lookup=function(e){this.pushStage(constant_1.PipelineStageName.lookup,e);return this};t.prototype.sort=function(e){this.pushStage(constant_1.PipelineStageName.sort,e);return this};t.prototype.limit=function(e){this.pushStage(constant_1.PipelineStageName.limit,e);return this};t.prototype.skip=function(e){this.pushStage(constant_1.PipelineStageName.skip,e);return this};t.prototype.unwind=function(e){this.pushStage(constant_1.PipelineStageName.unwind,e);return this};t.prototype.done=function(){return this.pipeline.map(function(e){var a,r;switch(e.name){case constant_1.PipelineStageName.match:return{$match:new QueryRequest_1.QueryRequest(e.param).toJSON()};case constant_1.PipelineStageName.count:case constant_1.PipelineStageName.sample:case constant_1.PipelineStageName.lookup:case constant_1.PipelineStageName.limit:case constant_1.PipelineStageName.skip:case constant_1.PipelineStageName.unwind:return a={},a[e.name]=e.param,a;case constant_1.PipelineStageName.addFields:case constant_1.PipelineStageName.group:case constant_1.PipelineStageName.project:case constant_1.PipelineStageName.replaceRoot:return r={},r[e.name]=new AggregateRequest_1.AggregateRequest(e.param).toJSON(),r;case constant_1.PipelineStageName.sort:return{$sort:Object.keys(e.param).reduce(function(n,p){var i;switch(e.param[p]){case constant_1.Sort.DESC:i=-1;break;case constant_1.Sort.ASC:i=1;break;case 1:i=1;break;case-1:i=-1;break;default:i=1}n[p]=i;return n},{})};default:{var o=e.name;throw error_1.DbBuildError.invalidParam(o,"\u4E0D\u652F\u6301\u7684 aggregate \u64CD\u4F5C")}}})};t.prototype.pushStage=function(e,a){this.pipeline.push({name:e,param:a})};return t}();exports.AggregatePipeline=AggregatePipeline;
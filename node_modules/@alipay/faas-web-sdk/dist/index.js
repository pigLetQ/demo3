!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t="undefined"!=typeof globalThis?globalThis:t||self).cloud={})}(this,(function(t){"use strict";function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},e(t,n)};var r=function(){return r=Object.assign||function(t){for(var n,e=1,r=arguments.length;e<r;e++)for(var o in n=arguments[e])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},r.apply(this,arguments)};function o(t,n,e,r){return new(e||(e=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function c(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var n;t.done?o(t.value):(n=t.value,n instanceof e?n:new e((function(t){t(n)}))).then(u,c)}a((r=r.apply(t,n||[])).next())}))}function i(t,n){var e,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(u=0)),u;)try{if(e=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,r=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=n.call(t,u)}catch(t){c=[6,t],r=0}finally{e=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}}"function"==typeof SuppressedError&&SuppressedError;var u,c,a,s,p,f,l=(u=function(t,n){return u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},u(t,n)},function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function e(){this.constructor=t}u(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}),h=function(t){function n(e,r){var o=t.call(this,r)||this;return o.name="FaasError",o.error=e,o.errorMessage=r,Object.setPrototypeOf(o,n.prototype),o}return l(n,t),Object.defineProperty(n.prototype,"errCode",{get:function(){return this.error},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"errMsg",{get:function(){return this.message},enumerable:!1,configurable:!0}),n.INVALID_PARAM_ERR=function(t,e){return new n(60001,"无效入参，参数 ".concat(t," ").concat(e))},n.NOT_FOUND_ERR=function(t){return new n(60001,t)},n.SERVER_ERR=function(t,e,r,o){var i=new n(t,e);return i.requestID=r,i.httpStatus=o,i},n.STORAGE_ERR=function(t,e,r){var o=new n(t,e);return o.requestID=r,o},n.NETWORK_ERR=function(t,e){var r=new n(-1,t.toString());return r.requestID=e,r},n}(Error),y=function(t,n){return void 0===n&&(n=void 0),function(e){if(!((null==e?void 0:e.complete)||(null==e?void 0:e.success)||(null==e?void 0:e.fail)))return t.call(n,e);var r=e.complete,o=e.success,i=e.fail,u=function(t,n){var e={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&n.indexOf(r)<0&&(e[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(t);o<r.length;o++)n.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(e[r[o]]=t[r[o]])}return e}(e,["complete","success","fail"]);t.call(n,u).then((function(t){return null==o||o(t),t}),(function(t){return null==i||i(t),t})).then((function(t){null==r||r(t)}))}},d=function(){function t(){}return t.handleResponse=function(t){if(200!==t.status){var n=t.data||{code:-1,message:"未知异常"},e=n.code,r=n.message;throw h.SERVER_ERR(e,r,t.requestID,t.status)}return t.data.data},t}(),v=function(t,n,e,r){return new(e||(e=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function c(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){t.done?o(t.value):function(t){return t instanceof e?t:new e((function(n){n(t)}))}(t.value).then(u,c)}a((r=r.apply(t,n||[])).next())}))},w=function(t,n){var e,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(u=0)),u;)try{if(e=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,r=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=n.call(t,u)}catch(t){c=[6,t],r=0}finally{e=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},m=function(t,n,e,r){return new(e||(e=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function c(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){t.done?o(t.value):function(t){return t instanceof e?t:new e((function(n){n(t)}))}(t.value).then(u,c)}a((r=r.apply(t,n||[])).next())}))},g=function(t,n){var e,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(u=0)),u;)try{if(e=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,r=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=n.call(t,u)}catch(t){c=[6,t],r=0}finally{e=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}};!function(t){t.DESC="desc",t.ASC="asc"}(c||(c={})),function(t){t.update="update",t.delete="delete",t.query="query",t.queryList="queryList",t.create="create"}(a||(a={})),function(t){t.update="update",t.findOneAndUpdate="findOneAndUpdate",t.replace="replace",t.delete="delete",t.query="query",t.queryList="queryList",t.create="create",t.batchCreate="batchCreate",t.count="count",t.aggregate="aggregate"}(s||(s={})),function(t){t.collection="collection",t.document="document"}(p||(p={})),function(t){t.addFields="$addFields",t.count="$count",t.match="$match",t.group="$group",t.project="$project",t.replaceRoot="$replaceRoot",t.sample="$sample",t.lookup="$lookup",t.sort="$sort",t.limit="$limit",t.skip="$skip",t.unwind="$unwind"}(f||(f={}));var b,_,O,A=(b=function(t,n){return b=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},b(t,n)},function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function e(){this.constructor=t}b(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}),x=function(){},P=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return A(n,t),n}(x),j=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return A(n,t),n}(P),S=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return A(n,t),n}(P),R=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return A(n,t),n}(j),C=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return A(n,t),n}(x),I=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return A(n,t),n}(C),E=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return A(n,t),n}(C),N=function(t){function n(n,e){var r=t.call(this)||this;return r.name="$"+n,r.value=e,r}return A(n,t),n.prototype.stringify=function(){var t;return(t={})[this.name]=this.value,t},n}(x),T=function(){function t(t){this.lastCmd=t}return t.unchain=function(n){return n instanceof t?n.lastCmd:n},t}(),k=(_=function(t,n){return _=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},_(t,n)},function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function e(){this.constructor=t}_(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)});!function(t){t.INVALID_PARAM="INVALID_PARAM",t.INVALID_COMMAND="INVALID_COMMAND",t.SEMANTIC_ERROR="SEMANTIC_ERROR"}(O||(O={}));var q,D,$,F=function(t){function n(e){var r=t.call(this,e)||this;return Object.setPrototypeOf(r,n.prototype),r}return k(n,t),n.create=function(t,e){var r=new n(e);return r.code=t,r},n.invalidParam=function(t,e){return n.create(O.INVALID_PARAM,'无效入参 "'.concat(t,'", ').concat(e))},n.invalidCommand=function(t){return n.create(O.INVALID_COMMAND,t)},n.semanticError=function(t){return n.create(O.SEMANTIC_ERROR,t)},n}(Error),M=function(){function t(t,n){void 0===n&&(n=""),this.data=t,this.prefix=n}return t.prototype.stringify=function(){var e=this;if(this.data instanceof x){if(!(this.data instanceof N))throw F.invalidCommand("Command 不是聚合操作");return this.data.stringify()}if(null===this.data||this.data instanceof Date)return this.data;if(Array.isArray(this.data))return this.data.map((function(n,r){return new t(n,"".concat(e.prefix,".$.").concat(r)).stringify()}));switch(n(this.data)){case"number":case"boolean":case"string":case"bigint":case"undefined":return this.data;case"function":throw F.invalidParam(this.prefix,"不支持函数");case"symbol":throw F.invalidParam(this.prefix,"不支持 symbol");default:var r={};for(var o in this.data){var i=this.prefix?"".concat(this.prefix,".").concat(o):o,u=new t(this.data[o],i).stringify();void 0!==u&&(r[o]=u)}return r}},t.prototype.toJSON=function(){var t=this.stringify();if(void 0===t)throw F.invalidParam(this.prefix,"不支持 undefined");return t},t}(),B=(q=function(t,n){return q=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},q(t,n)},function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function e(){this.constructor=t}q(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}),L=function(t){function n(n,e){return t.call(this,n,new M(e).toJSON())||this}return B(n,t),n}(N),U=function(t){function n(n){return t.call(this,"abs",n)||this}return B(n,t),n}(L),H=function(t){function n(n){return t.call(this,"add",n)||this}return B(n,t),n}(L),W=function(t){function n(n){return t.call(this,"addToSet",n)||this}return B(n,t),n}(L),V=function(t){function n(n){return t.call(this,"and",n)||this}return B(n,t),n}(L),K=function(t){function n(n){return t.call(this,"arrayElemAt",n)||this}return B(n,t),n}(L),z=function(t){function n(n){return t.call(this,"avg",n)||this}return B(n,t),n}(L),G=function(t){function n(n){return t.call(this,"ceil",n)||this}return B(n,t),n}(L),J=function(t){function n(n){return t.call(this,"cmp",n)||this}return B(n,t),n}(L),Y=function(t){function n(n){return t.call(this,"concat",n)||this}return B(n,t),n}(L),Q=function(t){function n(n){var e=Array.isArray(n)?{if:n[0],then:n[1],else:n[2]}:n;return t.call(this,"cond",e)||this}return B(n,t),n}(L),X=function(t){function n(){return t.call(this,"count",{})||this}return B(n,t),n.prototype.stringify=function(){return{$sum:1}},n}(L),Z=function(t){function n(n){return t.call(this,"dateToString",n)||this}return B(n,t),n}(L),tt=function(t){function n(n){return t.call(this,"divide",n)||this}return B(n,t),n}(L),nt=function(t){function n(n){return t.call(this,"eq",n)||this}return B(n,t),n}(L),et=function(t){function n(n){return t.call(this,"exp",n)||this}return B(n,t),n}(L),rt=function(t){function n(n){return t.call(this,"first",n)||this}return B(n,t),n}(L),ot=function(t){function n(n){return t.call(this,"floor",n)||this}return B(n,t),n}(L),it=function(t){function n(n){return t.call(this,"gt",n)||this}return B(n,t),n}(L),ut=function(t){function n(n){return t.call(this,"gte",n)||this}return B(n,t),n}(L),ct=function(t){function n(n){return t.call(this,"ifNull",n)||this}return B(n,t),n}(L),at=function(t){function n(n){return t.call(this,"in",n)||this}return B(n,t),n}(L),st=function(t){function n(n){return t.call(this,"indexOfArray",n)||this}return B(n,t),n}(L),pt=function(t){function n(n){return t.call(this,"isArray",n)||this}return B(n,t),n}(L),ft=function(t){function n(n){return t.call(this,"isoWeek",n)||this}return B(n,t),n}(L),lt=function(t){function n(n){return t.call(this,"last",n)||this}return B(n,t),n}(L),ht=function(t){function n(n){return t.call(this,"let",n)||this}return B(n,t),n}(L),yt=function(t){function n(n){return t.call(this,"ln",n)||this}return B(n,t),n}(L),dt=function(t){function n(n){return t.call(this,"log",n)||this}return B(n,t),n}(L),vt=function(t){function n(n){return t.call(this,"log10",n)||this}return B(n,t),n}(L),wt=function(t){function n(n){return t.call(this,"lt",n)||this}return B(n,t),n}(L),mt=function(t){function n(n){return t.call(this,"lte",n)||this}return B(n,t),n}(L),gt=function(t){function n(n){return t.call(this,"map",n)||this}return B(n,t),n}(L),bt=function(t){function n(n){return t.call(this,"max",n)||this}return B(n,t),n}(L),_t=function(t){function n(n){return t.call(this,"mergeObjects",n)||this}return B(n,t),n}(L),Ot=function(t){function n(n){return t.call(this,"min",n)||this}return B(n,t),n}(L),At=function(t){function n(n){return t.call(this,"mod",n)||this}return B(n,t),n}(L),xt=function(t){function n(n){return t.call(this,"month",n)||this}return B(n,t),n}(L),Pt=function(t){function n(n){return t.call(this,"multiply",n)||this}return B(n,t),n}(L),jt=function(t){function n(n){return t.call(this,"ne",n)||this}return B(n,t),n}(L),St=function(t){function n(n){return t.call(this,"not",[n])||this}return B(n,t),n}(L),Rt=function(t){function n(n){return t.call(this,"or",n)||this}return B(n,t),n}(L),Ct=function(t){function n(n){return t.call(this,"pow",n)||this}return B(n,t),n}(L),It=function(t){function n(n){return t.call(this,"push",n)||this}return B(n,t),n}(L),Et=function(t){function n(n){return t.call(this,"size",n)||this}return B(n,t),n}(L),Nt=function(t){function n(n){return t.call(this,"slice",n)||this}return B(n,t),n}(L),Tt=function(t){function n(n){return t.call(this,"split",n)||this}return B(n,t),n}(L),kt=function(t){function n(n){return t.call(this,"sqrt",n)||this}return B(n,t),n}(L),qt=function(t){function n(n){return t.call(this,"substr",n)||this}return B(n,t),n}(L),Dt=function(t){function n(n){return t.call(this,"substrBytes",n)||this}return B(n,t),n}(L),$t=function(t){function n(n){return t.call(this,"subtract",n)||this}return B(n,t),n}(L),Ft=function(t){function n(n){return t.call(this,"sum",n)||this}return B(n,t),n}(L),Mt=function(t){function n(n){var e=n.branches.map((function(t){return Array.isArray(t)?{case:t[0],then:t[1]}:{case:t.case,then:t.then}}));return t.call(this,"switch",{branches:e,default:n.default})||this}return B(n,t),n}(L),Bt=function(t){function n(n){return t.call(this,"toLower",n)||this}return B(n,t),n}(L),Lt=function(t){function n(n){return t.call(this,"toUpper",n)||this}return B(n,t),n}(L),Ut=function(t){function n(n){return t.call(this,"trunc",n)||this}return B(n,t),n}(L),Ht=function(t){function n(n){return t.call(this,"week",n)||this}return B(n,t),n}(L),Wt=function(t){function n(n){return t.call(this,"year",n)||this}return B(n,t),n}(L),Vt=function(){function t(t){this.regexp=t.regexp,this.options=t.options||""}return t.prototype.stringify=function(){return{$regex:this.regexp,$options:this.options}},t}(),Kt=function(){function t(){}return t.mergeTo=function(t,e){var r;for(var o in e)t[o]?Array.isArray(t[o])?(r=t[o]).push.apply(r,e[o]):"object"===n(t[o])&&"object"===n(e[o])?Object.assign(t[o],e[o]):t[o]=e[o]:t[o]=e[o]},t}(),zt=function(){function t(t,n,e){void 0===n&&(n=""),void 0===e&&(e=""),this.query=t,this.prefix=n,this.keyName=e}return t.prototype.stringify=function(){var e=this,r=T.unchain(this.query);if(r instanceof I)return r.stringifyWithKey(this.keyName);if(r instanceof C)return r.stringify();if(r instanceof Vt)return r.stringify();if(r instanceof RegExp)return r;if(r instanceof Date)return r;if(Array.isArray(r))return r.map((function(n,r){return new t(n,"".concat(e.prefix,".$.").concat(r)).stringify()}));var o=n(r);return"object"!==o?this.stringifyBuiltInValue(r,o):null===r?r:this.stringifyObject(r)},t.prototype.stringifyWithKey=function(){var e,r,o,i,u,c,a,s=this,p=T.unchain(this.query);if(p instanceof I)return p.stringifyWithKey(this.keyName);if(p instanceof C)return p instanceof E?p.stringify():((e={})[this.keyName]=p.stringify(),e);if(p instanceof Vt)return(r={})[this.keyName]=p.stringify(),r;if(p instanceof RegExp)return(o={})[this.keyName]=p,o;if(p instanceof Date)return(i={})[this.keyName]=p,i;if(Array.isArray(p)){var f=p.map((function(n,e){return new t(n,"".concat(s.prefix,".$.").concat(e)).stringify()}));return(u={})[this.keyName]=f,u}var l=n(p);return"object"!==l?((c={})[this.keyName]=this.stringifyBuiltInValue(p,l),c):null===p?((a={})[this.keyName]=p,a):this.stringifyObject(p)},t.prototype.toJSON=function(){var t=this.stringify();if(void 0===t)throw F.invalidParam(this.prefix,"不支持 undefined");return t},t.prototype.stringifyBuiltInValue=function(t,n){switch(n){case"number":case"boolean":case"string":case"bigint":default:return t;case"function":throw F.invalidParam(this.prefix,"不支持函数");case"symbol":throw F.invalidParam(this.prefix,"不支持 symbol");case"undefined":return}},t.prototype.stringifyObject=function(n){var e,r={};for(var o in n){var i=this.prefix?"".concat(this.prefix,".").concat(o):o,u=T.unchain(n[o]);if(u instanceof I){var c=u.stringifyWithKey(i);Kt.mergeTo(r,c)}else{var a=new t(u,i,o).stringify();void 0!==a&&Kt.mergeTo(r,((e={})[o]=a,e))}}return r},t}(),Gt=function(){function t(){this.pipeline=[]}return t.prototype.addFields=function(t){return this.pushStage(f.addFields,t),this},t.prototype.count=function(t){return this.pushStage(f.count,t),this},t.prototype.match=function(t){return this.pushStage(f.match,t),this},t.prototype.group=function(t){return this.pushStage(f.group,t),this},t.prototype.project=function(t){return this.pushStage(f.project,t),this},t.prototype.replaceRoot=function(t){return this.pushStage(f.replaceRoot,t),this},t.prototype.sample=function(t){return this.pushStage(f.sample,t),this},t.prototype.lookup=function(t){return this.pushStage(f.lookup,t),this},t.prototype.sort=function(t){return this.pushStage(f.sort,t),this},t.prototype.limit=function(t){return this.pushStage(f.limit,t),this},t.prototype.skip=function(t){return this.pushStage(f.skip,t),this},t.prototype.unwind=function(t){return this.pushStage(f.unwind,t),this},t.prototype.done=function(){return this.pipeline.map((function(t){var n,e;switch(t.name){case f.match:return{$match:new zt(t.param).toJSON()};case f.count:case f.sample:case f.lookup:case f.limit:case f.skip:case f.unwind:return(n={})[t.name]=t.param,n;case f.addFields:case f.group:case f.project:case f.replaceRoot:return(e={})[t.name]=new M(t.param).toJSON(),e;case f.sort:return{$sort:Object.keys(t.param).reduce((function(n,e){var r;switch(t.param[e]){case c.DESC:r=-1;break;case c.ASC:case 1:r=1;break;case-1:r=-1;break;default:r=1}return n[e]=r,n}),{})};default:var r=t.name;throw F.invalidParam(r,"不支持的 aggregate 操作")}}))},t.prototype.pushStage=function(t,n){this.pipeline.push({name:t,param:n})},t}(),Jt=(D=function(t,n){return D=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},D(t,n)},function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function e(){this.constructor=t}D(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}),Yt=function(t){function n(n){var e=t.call(this)||this;return e.val=n,e}return Jt(n,t),n.prototype.stringify=function(){return{$all:this.val}},n}(C),Qt=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),Xt=function(t){function n(n){var e,r=t.call(this)||this;return r.commands=[],(e=r.commands).push.apply(e,n),r}return Qt(n,t),Object.defineProperty(n.prototype,"op",{get:function(){return"$".concat(this.name)},enumerable:!1,configurable:!0}),n.prototype.pushCommand=function(t){this.commands.push(t)},n.prototype.stringifyWithKey=function(t){var n,e=this.commands.map((function(n){return new zt(n,"",t).stringifyWithKey()}));return(n={})[this.op]=e,n},n.prototype.stringify=function(){return this.stringifyWithKey("")},n}(I),Zt=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.name="and",n}return Qt(n,t),n}(Xt),tn=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.name="or",n}return Qt(n,t),n}(Xt),nn=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.name="nor",n}return Qt(n,t),n}(Xt),en=function(t){function n(n){var e=t.call(this)||this;return e.command=n,e}return Qt(n,t),n.prototype.stringifyWithKey=function(t){var n,e={$not:new zt(this.command,"",t).stringify()};return t?((n={})[t]=e,n):e},n.prototype.stringify=function(){return this.stringifyWithKey("")},n}(I),rn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),on=function(t){function n(n){var e=t.call(this)||this;return e.val=new zt(n).toJSON(),e}return rn(n,t),n.prototype.stringify=function(){return{$elemMatch:this.val}},n}(C),un=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),cn=function(t){function n(n){var e=t.call(this)||this;return e.val=n,e}return un(n,t),n.prototype.stringify=function(){return{$eq:this.val}},n}(C),an=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),sn=function(t){function n(n){var e=t.call(this)||this;return e.exists=n,e}return an(n,t),n.prototype.stringify=function(){return{$exists:this.exists}},n}(C),pn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),fn=function(t){function n(n){var e=t.call(this)||this;return e.commands=new M(n).toJSON(),e}return pn(n,t),n.prototype.stringify=function(){return{$expr:this.commands}},n}(E),ln=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),hn=function(t){function n(n){var e=t.call(this)||this;return e.val=n,e}return ln(n,t),n.prototype.stringify=function(){return{$gt:this.val}},n}(C),yn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),dn=function(t){function n(n){var e=t.call(this)||this;return e.val=n,e}return yn(n,t),n.prototype.stringify=function(){return{$gte:this.val}},n}(C),vn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),wn=function(t){function n(n){var e=t.call(this)||this;return e.val=n,e}return vn(n,t),n.prototype.stringify=function(){return{$in:this.val}},n}(C),mn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),gn=function(t){function n(n){var e=t.call(this)||this;return e.val=n,e}return mn(n,t),n.prototype.stringify=function(){return{$lt:this.val}},n}(C),bn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),_n=function(t){function n(n){var e=t.call(this)||this;return e.val=n,e}return bn(n,t),n.prototype.stringify=function(){return{$lte:this.val}},n}(C),On=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),An=function(t){function n(n,e){var r=t.call(this)||this;return r.divisor=n,r.remainder=e,r}return On(n,t),n.prototype.stringify=function(){return{$mod:[this.divisor,this.remainder]}},n}(C),xn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),Pn=function(t){function n(n){var e=t.call(this)||this;return e.val=n,e}return xn(n,t),n.prototype.stringify=function(){return{$ne:this.val}},n}(C),jn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),Sn=function(t){function n(n){var e=t.call(this)||this;return e.val=n,e}return jn(n,t),n.prototype.stringify=function(){return{$nin:this.val}},n}(C),Rn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),Cn=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return Rn(n,t),n.prototype.appendCommand=function(t){return t=n.unchain(t),this.lastCmd instanceof Zt?this.lastCmd.pushCommand(t):this.lastCmd=new Zt([this.lastCmd,t]),this},n.prototype.and=function(t){return this.appendCommand(t)},n.prototype.or=function(t){return t=n.unchain(t),this.lastCmd instanceof tn?this.lastCmd.pushCommand(t):this.lastCmd=new tn([this.lastCmd,t]),this},n.prototype.not=function(t){return this.appendCommand(t)},n.prototype.nor=function(t){return this.appendCommand(t)},n.prototype.eq=function(t){return this.appendCommand(new cn(t))},n.prototype.neq=function(t){return this.appendCommand(new Pn(t))},n.prototype.lt=function(t){return this.appendCommand(new gn(t))},n.prototype.lte=function(t){return this.appendCommand(new _n(t))},n.prototype.gt=function(t){return this.appendCommand(new hn(t))},n.prototype.gte=function(t){return this.appendCommand(new dn(t))},n.prototype.in=function(t){return this.appendCommand(new wn(t))},n.prototype.nin=function(t){return this.appendCommand(new Sn(t))},n.prototype.exists=function(t){return this.appendCommand(new sn(t))},n.prototype.mod=function(t,n){return this.appendCommand(new An(t,n))},n.prototype.all=function(t){return this.appendCommand(new Yt(t))},n.prototype.elemMatch=function(t){return this.appendCommand(new on(n.unchain(t)))},n.prototype.size=function(t){return this.appendCommand(t)},n}(T),In=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),En=function(t){function n(n){var e=t.call(this)||this;return e.val=n,e}return In(n,t),n.prototype.stringify=function(){return{$size:this.val}},n}(C),Nn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),Tn=function(t){function e(n){var e=t.call(this)||this;return e.value=n,e}return Nn(e,t),Object.defineProperty(e.prototype,"operator",{get:function(){return"$addToSet"},enumerable:!1,configurable:!0}),e.prototype.stringify=function(){return Array.isArray(this.value)?{$each:this.value}:"object"===n(this.value)&&this.value.hasOwnProperty("each")?{$each:this.value.each}:this.value},e}(S),kn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),qn=function(t){function n(n){var e=t.call(this)||this;return e.num=n,e}return kn(n,t),Object.defineProperty(n.prototype,"operator",{get:function(){return"$inc"},enumerable:!1,configurable:!0}),n.prototype.stringify=function(){return this.num},n}(P),Dn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),$n=function(t){function n(n){var e=t.call(this)||this;return e.num=n,e}return Dn(n,t),Object.defineProperty(n.prototype,"operator",{get:function(){return"$max"},enumerable:!1,configurable:!0}),n.prototype.stringify=function(){return this.num},n}(P),Fn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),Mn=function(t){function n(n){var e=t.call(this)||this;return e.num=n,e}return Fn(n,t),Object.defineProperty(n.prototype,"operator",{get:function(){return"$min"},enumerable:!1,configurable:!0}),n.prototype.stringify=function(){return this.num},n}(P),Bn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),Ln=function(t){function n(n){var e=t.call(this)||this;return e.num=n,e}return Bn(n,t),Object.defineProperty(n.prototype,"operator",{get:function(){return"$mul"},enumerable:!1,configurable:!0}),n.prototype.stringify=function(){return this.num},n}(P),Un=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),Hn=function(t){function n(n){var e=t.call(this)||this;return e.value=n,e}return Un(n,t),Object.defineProperty(n.prototype,"operator",{get:function(){return"$pop"},enumerable:!1,configurable:!0}),n.prototype.stringify=function(){return this.value||1},n}(S),Wn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),Vn=function(t){function n(n){var e=t.call(this)||this;return e.value=n,e}return Wn(n,t),Object.defineProperty(n.prototype,"operator",{get:function(){return"$pull"},enumerable:!1,configurable:!0}),n.prototype.stringify=function(){return this.stringifyWithKey("")},n.prototype.stringifyWithKey=function(t){var n;return new zt((n={},n[t]=this.value,n)).stringify()},n}(R),Kn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),zn=function(t){function n(n){var e=t.call(this)||this;return e.values=n,e}return Kn(n,t),Object.defineProperty(n.prototype,"operator",{get:function(){return"$pullAll"},enumerable:!1,configurable:!0}),n.prototype.stringify=function(){return this.values},n}(S),Gn=($=function(t,n){return $=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},$(t,n)},function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function e(){this.constructor=t}$(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}),Jn=function(){return Jn=Object.assign||function(t){for(var n,e=1,r=arguments.length;e<r;e++)for(var o in n=arguments[e])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},Jn.apply(this,arguments)},Yn=function(t){function e(e){for(var r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];var i=t.call(this)||this;return"object"===n(i.value)&&i.value.hasOwnProperty("each")?i.value=e:(null==r?void 0:r.length)>0?i.value=[].concat.apply([],function(t,n,e){if(e||2===arguments.length)for(var r,o=0,i=n.length;o<i;o++)!r&&o in n||(r||(r=Array.prototype.slice.call(n,0,o)),r[o]=n[o]);return t.concat(r||Array.prototype.slice.call(n))}([e],r,!1)):i.value=e,i}return Gn(e,t),Object.defineProperty(e.prototype,"operator",{get:function(){return"$push"},enumerable:!1,configurable:!0}),e.prototype.stringify=function(){if(Array.isArray(this.value))return{$each:this.value};if("object"===n(this.value)&&this.value.hasOwnProperty("each")){var t=this.value,e={$each:t.each};return void 0!==t.position&&(e.$position=t.position),void 0!==t.slice&&(e.$slice=t.slice),void 0!==t.sort&&("string"==typeof t.sort?e.$sort=t.sort===c.DESC?-1:1:e.$sort=t.sort),e}return"object"===n(this.value)&&"string"==typeof this.value.$sort?Jn(Jn({},this.value),{$sort:this.value.$sort===c.DESC?-1:1}):this.value},e}(S),Qn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),Xn=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return Qn(n,t),Object.defineProperty(n.prototype,"operator",{get:function(){return"$unset"},enumerable:!1,configurable:!0}),n.prototype.stringify=function(){return""},n}(P),Zn=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),te=function(t){function n(n){var e=t.call(this)||this;return e.name=n,e}return Zn(n,t),Object.defineProperty(n.prototype,"operator",{get:function(){return"$rename"},enumerable:!1,configurable:!0}),n.prototype.stringify=function(){return this.name},n}(P),ne=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),ee=function(t){function n(n){var e=t.call(this)||this;return e.data=n,e}return ne(n,t),Object.defineProperty(n.prototype,"operator",{get:function(){return"$set"},enumerable:!1,configurable:!0}),n.prototype.stringify=function(){return this.data},n}(P),re=function(t,n,e){if(e||2===arguments.length)for(var r,o=0,i=n.length;o<i;o++)!r&&o in n||(r||(r=Array.prototype.slice.call(n,0,o)),r[o]=n[o]);return t.concat(r||Array.prototype.slice.call(n))},oe=function(){function t(){}return t.prototype.pipeline=function(){return new Gt},t.prototype.avg=function(t){return new z(t)},t.prototype.count=function(){return new X},t.prototype.max=function(t){return new bt(t)},t.prototype.min=function(t){return new Ot(t)},t.prototype.sum=function(t){return new Ft(t)},t.prototype.and=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];var r=Array.isArray(t)?t:re([t],n,!0);return new V(r)},t.prototype.or=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];var r=Array.isArray(t)?t:re([t],n,!0);return new Rt(r)},t.prototype.not=function(t){return new St(t)},t.prototype.cmp=function(t,n){var e=Array.isArray(t)?t:[t,n];return new J(e)},t.prototype.eq=function(t,n){var e=Array.isArray(t)?t:[t,n];return new nt(e)},t.prototype.neq=function(t,n){var e=Array.isArray(t)?t:[t,n];return new jt(e)},t.prototype.lt=function(t,n){var e=Array.isArray(t)?t:[t,n];return new wt(e)},t.prototype.lte=function(t,n){var e=Array.isArray(t)?t:[t,n];return new mt(e)},t.prototype.gt=function(t,n){var e=Array.isArray(t)?t:[t,n];return new it(e)},t.prototype.gte=function(t,n){var e=Array.isArray(t)?t:[t,n];return new ut(e)},t.prototype.addToSet=function(t){return new W(t)},t.prototype.arrayElemAt=function(t,n){var e=Array.isArray(t)?t:[t,n];return new K(e)},t.prototype.indexOfArray=function(t,n,e,r){var o=Array.isArray(t)?t:[t,n,e,r].filter((function(t){return void 0!==t}));return new st(o)},t.prototype.isArray=function(t){return new pt(t)},t.prototype.size=function(t){return new Et(t)},t.prototype.in=function(t,n){var e=Array.isArray(t)?t:[t,n];return new at(e)},t.prototype.slice=function(t,n,e){var r=Array.isArray(t)?t:[t,n,e].filter((function(t){return void 0!==t}));return new Nt(r)},t.prototype.map=function(t){return new gt(t)},t.prototype.ifNull=function(t,n){var e=Array.isArray(t)?t:[t,n];return new ct(e)},t.prototype.cond=function(t){return new Q(t)},t.prototype.switch=function(t){return new Mt(t)},t.prototype.concat=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];var r=Array.isArray(t)?t:re([t],n,!0);return new Y(r)},t.prototype.dateToString=function(t){return new Z(t)},t.prototype.toLower=function(t){return new Bt(t)},t.prototype.toUpper=function(t){return new Lt(t)},t.prototype.split=function(t,n){var e=Array.isArray(t)?t:[t,n];return new Tt(e)},t.prototype.substr=function(t,n,e){var r=Array.isArray(t)?t:[t,n,e];return new qt(r)},t.prototype.substrBytes=function(t,n,e){var r=Array.isArray(t)?t:[t,n,e];return new Dt(r)},t.prototype.first=function(t){return new rt(t)},t.prototype.last=function(t){return new lt(t)},t.prototype.push=function(t){return new It(t)},t.prototype.let=function(t){return new ht(t)},t.prototype.add=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];var r=Array.isArray(t)?t:re([t],n,!0);return new H(r)},t.prototype.subtract=function(t,n){var e=Array.isArray(t)?t:[t,n];return new $t(e)},t.prototype.multiply=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];var r=Array.isArray(t)?t:re([t],n,!0);return new Pt(r)},t.prototype.divide=function(t,n){var e=Array.isArray(t)?t:[t,n];return new tt(e)},t.prototype.abs=function(t){return new U(t)},t.prototype.ceil=function(t){return new G(t)},t.prototype.exp=function(t){return new et(t)},t.prototype.floor=function(t){return new ot(t)},t.prototype.ln=function(t){return new yt(t)},t.prototype.log=function(t,n){var e=Array.isArray(t)?t:[t,n];return new dt(e)},t.prototype.log10=function(t){return new vt(t)},t.prototype.mod=function(t,n){var e=Array.isArray(t)?t:[t,n];return new At(e)},t.prototype.pow=function(t,n){var e=Array.isArray(t)?t:[t,n];return new Ct(e)},t.prototype.sqrt=function(t){return new kt(t)},t.prototype.trunc=function(t){return new Ut(t)},t.prototype.mergeObjects=function(t){return new _t(t)},t.prototype.month=function(t){return new xt(t)},t.prototype.year=function(t){return new Wt(t)},t.prototype.week=function(t){return new Ht(t)},t.prototype.isoWeek=function(t){return new ft(t)},t}(),ie=function(){function t(){this.aggregate=new oe,this.Sort=c}return t.prototype.addToSet=function(t){return new Tn(t)},t.prototype.inc=function(t){return new qn(t)},t.prototype.max=function(t){return new $n(t)},t.prototype.min=function(t){return new Mn(t)},t.prototype.mul=function(t){return new Ln(t)},t.prototype.pop=function(t){return new Hn(t)},t.prototype.pull=function(t){return new Vn(t)},t.prototype.pullAll=function(t){return new zn(t)},t.prototype.push=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return new(Yn.bind.apply(Yn,re([void 0,t],n,!1)))},t.prototype.remove=function(){return new Xn},t.prototype.rename=function(t){return new te(t)},t.prototype.set=function(t){return new ee(t)},t.prototype.expr=function(t){return new fn(t)},t.prototype.and=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];t=Array.isArray(t[0])?t[0]:t;var e=new Zt(t.map(Cn.unchain));return new Cn(e)},t.prototype.or=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];t=Array.isArray(t[0])?t[0]:t;var e=new tn(t.map(Cn.unchain));return new Cn(e)},t.prototype.not=function(t){var n=new en(Cn.unchain(t));return new Cn(n)},t.prototype.nor=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];t=Array.isArray(t[0])?t[0]:t;var e=new nn(t.map(Cn.unchain));return new Cn(e)},t.prototype.eq=function(t){return new Cn(new cn(t))},t.prototype.neq=function(t){return new Cn(new Pn(t))},t.prototype.lt=function(t){return new Cn(new gn(t))},t.prototype.lte=function(t){return new Cn(new _n(t))},t.prototype.gt=function(t){return new Cn(new hn(t))},t.prototype.gte=function(t){return new Cn(new dn(t))},t.prototype.in=function(t){return new Cn(new wn(t))},t.prototype.nin=function(t){return new Cn(new Sn(t))},t.prototype.exists=function(t){return new Cn(new sn(t))},t.prototype.mod=function(t,n){return new Cn(new An(t,n))},t.prototype.all=function(t){return new Cn(new Yt(t))},t.prototype.elemMatch=function(t){return new Cn(new on(Cn.unchain(t)))},t.prototype.size=function(t){return new Cn(new En(t))},t}(),ue=function(){function t(){}return t.buildCollectionAction=function(t,n){return{target:p.collection,action:t,collectionName:n}},t.buildCollectionListQueryAction=function(t){return{target:p.collection,action:a.queryList,options:t}},t.buildDocumentAction=function(t,n,e){return{target:p.document,action:t,collectionName:n,options:e}},t}(),ce=function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),ae=function(t){function n(n){var e=t.call(this)||this;return e.collectionName=n,e}return ce(n,t),n.prototype.end=function(){var t={$aggregate:this.done()};return ue.buildDocumentAction(s.aggregate,this.collectionName,t)},n}(Gt),se=function(){function t(){this.res={}}return t.prototype.set=function(t,n){this.res.$set=this.res.$set||{},this.res.$set[t]=n},t.prototype.applyOperator=function(t,n,e){this.res[t]=this.res[t]||{},this.res[t][n]=e},t.prototype.mergeOperator=function(t,n){this.res[t]||(this.res[t]={}),Kt.mergeTo(this.res[t],n)},t.prototype.emit=function(){return this.res},t}(),pe=function(){function t(t,n){void 0===n&&(n=""),this.data=t,this.prefix=n}return t.prototype.stringify=function(e){for(var r in e=e||new se,this.data){var o=this.prefix?"".concat(this.prefix,".").concat(r):r,i=this.data[r],u=n(i);if(i instanceof x){if(!(i instanceof P))throw F.invalidCommand("Command 不是更新操作");i instanceof j?e.mergeOperator(i.operator,i.stringifyWithKey(o)):e.applyOperator(i.operator,o,i.stringify())}else if(i instanceof Date)e.set(o,i);else if("number"===u)e.set(o,i);else if("boolean"===u)e.set(o,i);else if("string"===u)e.set(o,i);else if("bigint"===u)e.set(o,i);else{if("function"===u)throw F.invalidParam(o,"不支持函数");if("symbol"===u)throw F.invalidParam(o,"不支持 symbol");if("undefined"===u);else if(null===i)e.set(o,i);else if(Array.isArray(i))e.set(o,i);else{new t(i,o).stringify(e)}}}return e},t.prototype.toJSON=function(){return this.stringify().emit()},t}(),fe=function(){return fe=Object.assign||function(t){for(var n,e=1,r=arguments.length;e<r;e++)for(var o in n=arguments[e])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},fe.apply(this,arguments)},le=function(){function t(t){this.collectionName=t,this.criteria={sort:[]}}return t.prototype.limit=function(t){return this.criteria.limit=t,this},t.prototype.skip=function(t){return this.criteria.skip=t,this},t.prototype.where=function(t){return this.criteria.match=t,this},t.prototype.projection=function(t){for(var e in t)t[e]?"object"!==n(t[e])&&(t[e]=1):t[e]=0;return this.criteria.projection=t,this},t.prototype.orderBy=function(t,n){return this.criteria.sort.push({field:t,sort:n}),this},t.prototype.update=function(t){return this.build(s.update,fe(fe({},this.baseOptions()),{$update:new pe(t.data).toJSON()}))},t.prototype.updateAndReturn=function(t){var n=this.findOptions();return this.build(s.findOneAndUpdate,{$match:n.$match,$update:new pe(t.data).toJSON(),$options:{$sort:n.$sort,$returnDocument:"after",$upsert:!1}})},t.prototype.set=function(t){return this.build(s.replace,fe(fe({},this.baseOptions()),{$replace:t.data,$upsert:!0}))},t.prototype.remove=function(){return this.build(s.delete,this.baseOptions())},t.prototype.get=function(){return this.build(s.queryList,fe({$limit:100},this.findOptions()))},t.prototype.count=function(){return this.build(s.count,this.baseOptions())},t.prototype.baseOptions=function(){var t={};if(void 0!==this.criteria.match){var n=new zt(this.criteria.match);t.$match=n.toJSON()}return void 0!==this.criteria.limit&&(t.$limit=this.criteria.limit),t},t.prototype.findOptions=function(){var t=this.baseOptions();if(void 0!==this.criteria.projection&&(t.$project=this.criteria.projection),void 0!==this.criteria.sort){t.$sort={};for(var n=0,e=this.criteria.sort;n<e.length;n++){var r=e[n];t.$sort[r.field]=r.sort===c.DESC?-1:1}}return void 0!==this.criteria.skip&&(t.$skip=this.criteria.skip),t},t.prototype.build=function(t,n){return ue.buildDocumentAction(t,this.collectionName,n)},t}(),he=function(){function t(t,n){this.collectionName=t,this.id=n}return t.prototype.update=function(t){return new le(this.collectionName).where({_id:String(this.id)}).limit(1).update(t)},t.prototype.set=function(t){return new le(this.collectionName).where({_id:String(this.id)}).limit(1).set(t)},t.prototype.remove=function(){return new le(this.collectionName).where({_id:String(this.id)}).limit(1).remove()},t.prototype.get=function(){var t=new le(this.collectionName).where({_id:String(this.id)}).limit(1).get();return t.action=s.query,t},t}(),ye=function(){return ye=Object.assign||function(t){for(var n,e=1,r=arguments.length;e<r;e++)for(var o in n=arguments[e])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},ye.apply(this,arguments)},de=function(){function t(t,n){this.collectionName=t,this.options=ye({maxAddCount:200},n)}return t.prototype.add=function(t){if(!(null==t?void 0:t.data))throw F.invalidParam("data","不能为空");return Array.isArray(t.data)?this.batchAdd(t):ue.buildDocumentAction(s.create,this.collectionName,t.data)},t.prototype.batchAdd=function(t){if(t.data.length<=0)throw F.invalidParam("data","不能为空数组");if(t.data.length>this.options.maxAddCount)throw F.invalidParam("data","最大长度 ".concat(this.options.maxAddCount));var n={$create:t.data};return"boolean"==typeof t.ordered&&(n.$ordered=t.ordered),ue.buildDocumentAction(s.batchCreate,this.collectionName,n)},t.prototype.doc=function(t){return new he(this.collectionName,t)},t.prototype.limit=function(t){return new le(this.collectionName).limit(t)},t.prototype.skip=function(t){return new le(this.collectionName).skip(t)},t.prototype.where=function(t){return new le(this.collectionName).where(t)},t.prototype.projection=function(t){return new le(this.collectionName).projection(t)},t.prototype.orderBy=function(t,n){return new le(this.collectionName).orderBy(t,n)},t.prototype.aggregate=function(){return new ae(this.collectionName)},t.prototype.get=function(){return new le(this.collectionName).get()},t.prototype.count=function(){return new le(this.collectionName).count()},t}(),ve=function(t,n,e,r){return new(e||(e=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function c(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){t.done?o(t.value):function(t){return t instanceof e?t:new e((function(n){n(t)}))}(t.value).then(u,c)}a((r=r.apply(t,n||[])).next())}))},we=function(t,n){var e,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(u=0)),u;)try{if(e=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,r=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=n.call(t,u)}catch(t){c=[6,t],r=0}finally{e=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}};function me(){return function(t,n,e){var r=e.value;e.value=function(t){return ve(this,void 0,void 0,(function(){return we(this,(function(n){return[2,y(r,this)(t)]}))}))}}}var ge,be=function(t,e){if("object"===("undefined"==typeof Reflect?"undefined":n(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},_e=function(t,n,e,r){return new(e||(e=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function c(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){t.done?o(t.value):function(t){return t instanceof e?t:new e((function(n){n(t)}))}(t.value).then(u,c)}a((r=r.apply(t,n||[])).next())}))},Oe=function(t,n){var e,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(u=0)),u;)try{if(e=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,r=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=n.call(t,u)}catch(t){c=[6,t],r=0}finally{e=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},Ae=function(){function t(t,n){this.collectionName=t,this.options=n,this.builder=new ae(t)}return t.prototype.addFields=function(t){return this.builder.addFields(t),this},t.prototype.count=function(t){return this.builder.count(t),this},t.prototype.match=function(t){return this.builder.match(t),this},t.prototype.group=function(t){return this.builder.group(t),this},t.prototype.sample=function(t){return this.builder.sample(t),this},t.prototype.lookup=function(t){return this.builder.lookup(t),this},t.prototype.project=function(t){return this.builder.project(t),this},t.prototype.replaceRoot=function(t){return this.builder.replaceRoot(t),this},t.prototype.sort=function(t){return this.builder.sort(t),this},t.prototype.limit=function(t){return this.builder.limit(t),this},t.prototype.skip=function(t){return this.builder.skip(t),this},t.prototype.unwind=function(t){return this.builder.unwind(t),this},t.prototype.end=function(){return _e(this,void 0,void 0,(function(){var t,n,e;return Oe(this,(function(r){switch(r.label){case 0:return t=this.builder.end().options,"POST",n="".concat(this.getCollectionPath(),"?aggregate"),[4,this.options.httpclient.request({method:"POST",path:n,data:t})];case 1:return e=r.sent(),[2,d.handleResponse(e)]}}))}))},t.prototype.getCollectionPath=function(){return"/".concat(this.options.databaseName||"faas","/").concat(this.collectionName)},function(t,e,r,o){var i,u=arguments.length,c=u<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,r):o;if("object"===("undefined"==typeof Reflect?"undefined":n(Reflect))&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,r,o);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(c=(u<3?i(c):u>3?i(e,r,c):i(e,r))||c);u>3&&c&&Object.defineProperty(e,r,c)}([me(),be("design:type",Function),be("design:paramtypes",[]),be("design:returntype",Promise)],t.prototype,"end",null),t}(),xe=function(t,e,r,o){var i,u=arguments.length,c=u<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,r):o;if("object"===("undefined"==typeof Reflect?"undefined":n(Reflect))&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,r,o);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(c=(u<3?i(c):u>3?i(e,r,c):i(e,r))||c);return u>3&&c&&Object.defineProperty(e,r,c),c},Pe=function(t,e){if("object"===("undefined"==typeof Reflect?"undefined":n(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},je=function(t,n,e,r){return new(e||(e=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function c(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){t.done?o(t.value):function(t){return t instanceof e?t:new e((function(n){n(t)}))}(t.value).then(u,c)}a((r=r.apply(t,n||[])).next())}))},Se=function(t,n){var e,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(u=0)),u;)try{if(e=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,r=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=n.call(t,u)}catch(t){c=[6,t],r=0}finally{e=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},Re=function(){function t(t,n){this.collectionName=t,this.options=n,this.builder=new le(t)}return t.prototype.limit=function(t){return this.builder.limit(t),this},t.prototype.skip=function(t){return this.builder.skip(t),this},t.prototype.where=function(t){return this.builder.where(t),this},t.prototype.projection=function(t){return this.builder.projection(t),this},t.prototype.field=function(t){return this.builder.projection(t),this},t.prototype.orderBy=function(t,n){return this.builder.orderBy(t,n),this},t.prototype.updateAndReturn=function(t){return je(this,void 0,void 0,(function(){var n,e,r,o;return Se(this,(function(i){switch(i.label){case 0:return"POST",n="".concat(this.getCollectionPath(),"?findOneAndUpdate"),e=this.builder.updateAndReturn(t).options,[4,this.options.httpclient.request({method:"POST",path:n,data:e})];case 1:return r=i.sent(),[2,{updated:(o=d.handleResponse(r))?1:0,doc:o}]}}))}))},t.prototype.update=function(t){return je(this,void 0,void 0,(function(){var n,e,r;return Se(this,(function(o){switch(o.label){case 0:return"POST",n="".concat(this.getCollectionPath(),"?update"),e=this.builder.update(t).options,[4,this.options.httpclient.request({method:"POST",path:n,data:e})];case 1:return r=o.sent(),[2,d.handleResponse(r)]}}))}))},t.prototype.set=function(t){return je(this,void 0,void 0,(function(){var n,e,r;return Se(this,(function(o){switch(o.label){case 0:return"POST",n="".concat(this.getCollectionPath(),"?replace"),e=this.builder.set(t).options,[4,this.options.httpclient.request({method:"POST",path:n,data:e})];case 1:return r=o.sent(),[2,d.handleResponse(r)]}}))}))},t.prototype.remove=function(){return je(this,void 0,void 0,(function(){var t,n,e;return Se(this,(function(r){switch(r.label){case 0:return"POST",t="".concat(this.getCollectionPath(),"?delete"),n=this.builder.remove().options,[4,this.options.httpclient.request({method:"POST",path:t,data:n})];case 1:return e=r.sent(),[2,d.handleResponse(e)]}}))}))},t.prototype.get=function(){return je(this,void 0,void 0,(function(){var t,n,e;return Se(this,(function(r){switch(r.label){case 0:return"POST",t="".concat(this.getCollectionPath(),"?query"),n=this.builder.get().options,[4,this.options.httpclient.request({method:"POST",path:t,data:n})];case 1:return e=r.sent(),[2,d.handleResponse(e)]}}))}))},t.prototype.count=function(){return je(this,void 0,void 0,(function(){var t,n,e;return Se(this,(function(r){switch(r.label){case 0:return"POST",t="".concat(this.getCollectionPath(),"?count"),n=this.builder.count().options,[4,this.options.httpclient.request({method:"POST",path:t,data:n})];case 1:return e=r.sent(),[2,{total:d.handleResponse(e).count}]}}))}))},t.prototype.getCollectionPath=function(){return"/".concat(this.options.databaseName||"faas","/").concat(this.collectionName)},xe([me(),Pe("design:type",Function),Pe("design:paramtypes",[Object]),Pe("design:returntype",Promise)],t.prototype,"updateAndReturn",null),xe([me(),Pe("design:type",Function),Pe("design:paramtypes",[Object]),Pe("design:returntype",Promise)],t.prototype,"update",null),xe([me(),Pe("design:type",Function),Pe("design:paramtypes",[Object]),Pe("design:returntype",Promise)],t.prototype,"set",null),xe([me(),Pe("design:type",Function),Pe("design:paramtypes",[]),Pe("design:returntype",Promise)],t.prototype,"remove",null),xe([me(),Pe("design:type",Function),Pe("design:paramtypes",[]),Pe("design:returntype",Promise)],t.prototype,"get",null),xe([me(),Pe("design:type",Function),Pe("design:paramtypes",[]),Pe("design:returntype",Promise)],t.prototype,"count",null),t}(),Ce=function(t,e,r,o){var i,u=arguments.length,c=u<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,r):o;if("object"===("undefined"==typeof Reflect?"undefined":n(Reflect))&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,r,o);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(c=(u<3?i(c):u>3?i(e,r,c):i(e,r))||c);return u>3&&c&&Object.defineProperty(e,r,c),c},Ie=function(t,e){if("object"===("undefined"==typeof Reflect?"undefined":n(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Ee=function(t,n,e,r){return new(e||(e=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function c(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){t.done?o(t.value):function(t){return t instanceof e?t:new e((function(n){n(t)}))}(t.value).then(u,c)}a((r=r.apply(t,n||[])).next())}))},Ne=function(t,n){var e,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(u=0)),u;)try{if(e=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,r=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=n.call(t,u)}catch(t){c=[6,t],r=0}finally{e=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},Te=function(){function t(t,n,e){this.collectionName=t,this.id=n,this.options=e}return t.prototype.projection=function(t){return this.query.projection(t),this},t.prototype.field=function(t){return this.query.field(t),this},t.prototype.update=function(t){return Ee(this,void 0,void 0,(function(){return Ne(this,(function(n){switch(n.label){case 0:return[4,this.query.update(t)];case 1:return[2,n.sent()]}}))}))},t.prototype.updateAndReturn=function(t){return Ee(this,void 0,void 0,(function(){return Ne(this,(function(n){switch(n.label){case 0:return[4,this.query.updateAndReturn(t)];case 1:return[2,n.sent()]}}))}))},t.prototype.set=function(t){return Ee(this,void 0,void 0,(function(){return Ne(this,(function(n){switch(n.label){case 0:return[4,this.query.set(t)];case 1:return[2,n.sent()]}}))}))},t.prototype.remove=function(){return Ee(this,void 0,void 0,(function(){return Ne(this,(function(t){switch(t.label){case 0:return[4,this.query.remove()];case 1:return[2,t.sent()]}}))}))},t.prototype.get=function(){return Ee(this,void 0,void 0,(function(){var t,n;return Ne(this,(function(e){switch(e.label){case 0:return[4,this.query.get()];case 1:if(t=e.sent(),!(n=t[0])){if(this.options.throwOnNotFound)throw h.NOT_FOUND_ERR("不存在_id 为 ".concat(this.id," 的文档"));return[2,null]}return[2,n]}}))}))},Object.defineProperty(t.prototype,"query",{get:function(){return this._query||(this._query=new Re(this.collectionName,this.options).where({_id:String(this.id)}).limit(1)),this._query},enumerable:!1,configurable:!0}),Ce([me(),Ie("design:type",Function),Ie("design:paramtypes",[Object]),Ie("design:returntype",Promise)],t.prototype,"update",null),Ce([me(),Ie("design:type",Function),Ie("design:paramtypes",[Object]),Ie("design:returntype",Promise)],t.prototype,"updateAndReturn",null),Ce([me(),Ie("design:type",Function),Ie("design:paramtypes",[Object]),Ie("design:returntype",Promise)],t.prototype,"set",null),Ce([me(),Ie("design:type",Function),Ie("design:paramtypes",[]),Ie("design:returntype",Promise)],t.prototype,"remove",null),Ce([me(),Ie("design:type",Function),Ie("design:paramtypes",[]),Ie("design:returntype",Promise)],t.prototype,"get",null),t}(),ke=function(t,e,r,o){var i,u=arguments.length,c=u<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,r):o;if("object"===("undefined"==typeof Reflect?"undefined":n(Reflect))&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,r,o);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(c=(u<3?i(c):u>3?i(e,r,c):i(e,r))||c);return u>3&&c&&Object.defineProperty(e,r,c),c},qe=function(t,e){if("object"===("undefined"==typeof Reflect?"undefined":n(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},De=function(t,n,e,r){return new(e||(e=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function c(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){t.done?o(t.value):function(t){return t instanceof e?t:new e((function(n){n(t)}))}(t.value).then(u,c)}a((r=r.apply(t,n||[])).next())}))},$e=function(t,n){var e,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(u=0)),u;)try{if(e=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,r=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=n.call(t,u)}catch(t){c=[6,t],r=0}finally{e=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},Fe=function(){function t(t,n){this.collectionName=t,this.options=n,this.builder=new de(t)}return t.prototype.add=function(t){return De(this,void 0,void 0,(function(){var n,e,r;return $e(this,(function(o){switch(o.label){case 0:return n=this.builder.add(t).options,"POST",e=this.getDocumentPath(t.data._id),[4,this.options.httpclient.request({method:"POST",path:e,data:n})];case 1:return r=o.sent(),[2,d.handleResponse(r)]}}))}))},t.prototype.doc=function(t){return new Te(this.collectionName,t,this.options)},t.prototype.limit=function(t){return new Re(this.collectionName,this.options).limit(t)},t.prototype.skip=function(t){return new Re(this.collectionName,this.options).skip(t)},t.prototype.where=function(t){return new Re(this.collectionName,this.options).where(t)},t.prototype.projection=function(t){return new Re(this.collectionName,this.options).projection(t)},t.prototype.field=function(t){return new Re(this.collectionName,this.options).field(t)},t.prototype.orderBy=function(t,n){return new Re(this.collectionName,this.options).orderBy(t,n)},t.prototype.aggregate=function(){return new Ae(this.collectionName,this.options)},t.prototype.update=function(t){return De(this,void 0,void 0,(function(){return $e(this,(function(n){switch(n.label){case 0:return[4,new Re(this.collectionName,this.options).update(t)];case 1:return[2,n.sent()]}}))}))},t.prototype.updateAndReturn=function(t){return De(this,void 0,void 0,(function(){return $e(this,(function(n){switch(n.label){case 0:return[4,new Re(this.collectionName,this.options).updateAndReturn(t)];case 1:return[2,n.sent()]}}))}))},t.prototype.set=function(t){return De(this,void 0,void 0,(function(){return $e(this,(function(n){switch(n.label){case 0:return[4,new Re(this.collectionName,this.options).set(t)];case 1:return[2,n.sent()]}}))}))},t.prototype.remove=function(){return De(this,void 0,void 0,(function(){return $e(this,(function(t){switch(t.label){case 0:return[4,new Re(this.collectionName,this.options).remove()];case 1:return[2,t.sent()]}}))}))},t.prototype.get=function(){return De(this,void 0,void 0,(function(){return $e(this,(function(t){switch(t.label){case 0:return[4,new Re(this.collectionName,this.options).get()];case 1:return[2,t.sent()]}}))}))},t.prototype.count=function(){return De(this,void 0,void 0,(function(){return $e(this,(function(t){switch(t.label){case 0:return[4,new Re(this.collectionName,this.options).count()];case 1:return[2,t.sent()]}}))}))},t.prototype.getDocumentPath=function(t){return"/".concat(this.options.databaseName||"faas","/").concat(this.collectionName,"?_id=").concat(t||"")},ke([me(),qe("design:type",Function),qe("design:paramtypes",[Object]),qe("design:returntype",Promise)],t.prototype,"add",null),ke([me(),qe("design:type",Function),qe("design:paramtypes",[Object]),qe("design:returntype",Promise)],t.prototype,"update",null),ke([me(),qe("design:type",Function),qe("design:paramtypes",[Object]),qe("design:returntype",Promise)],t.prototype,"updateAndReturn",null),ke([me(),qe("design:type",Function),qe("design:paramtypes",[Object]),qe("design:returntype",Promise)],t.prototype,"set",null),ke([me(),qe("design:type",Function),qe("design:paramtypes",[]),qe("design:returntype",Promise)],t.prototype,"remove",null),ke([me(),qe("design:type",Function),qe("design:paramtypes",[]),qe("design:returntype",Promise)],t.prototype,"get",null),ke([me(),qe("design:type",Function),qe("design:paramtypes",[]),qe("design:returntype",Promise)],t.prototype,"count",null),t}(),Me=function(){return Me=Object.assign||function(t){for(var n,e=1,r=arguments.length;e<r;e++)for(var o in n=arguments[e])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},Me.apply(this,arguments)},Be=function(t,n,e,r){return new(e||(e=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function c(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){t.done?o(t.value):function(t){return t instanceof e?t:new e((function(n){n(t)}))}(t.value).then(u,c)}a((r=r.apply(t,n||[])).next())}))},Le=function(t,n){var e,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(u=0)),u;)try{if(e=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,r=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=n.call(t,u)}catch(t){c=[6,t],r=0}finally{e=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},Ue=function(){function t(t){this.httpclient=t}return t.prototype.request=function(t){var n=t.method,e=t.path,r=t.data,o=t.headers;return Be(this,void 0,void 0,(function(){return Le(this,(function(t){switch(t.label){case 0:return[4,this.httpclient.request({method:n,path:e,data:r,headers:Me({"x-alipay-cloud-mode":"mongo","x-data-api-type":"mongo","x-expire-timestamp":"".concat(Date.now()+6e4)},o)})];case 1:return[2,t.sent()]}}))}))},t}(),He=function(){function t(t){this.command=new ie,this.options=Me(Me({},t),{httpclient:new Ue(t.httpclient)})}return t.prototype.collection=function(t){if(!t)throw h.INVALID_PARAM_ERR("collectionName","不能为空");return new Fe(t,this.options)},t}(),We=function(){return We=Object.assign||function(t){for(var n,e=1,r=arguments.length;e<r;e++)for(var o in n=arguments[e])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},We.apply(this,arguments)},Ve=function(t,n,e,r){return new(e||(e=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function c(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){t.done?o(t.value):function(t){return t instanceof e?t:new e((function(n){n(t)}))}(t.value).then(u,c)}a((r=r.apply(t,n||[])).next())}))},Ke=function(t,n){var e,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(u=0)),u;)try{if(e=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,r=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=n.call(t,u)}catch(t){c=[6,t],r=0}finally{e=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}},ze=function(){function t(t){this.options=t}return t.prototype.getUploadPath=function(t){return"/".concat(t,"?upload_url")},t.prototype.getDownloadPath=function(t){return"/".concat(t,"?download_url&expire=3600")},t.prototype.getBatchDeletePath=function(){return"/?delete"},t.prototype.getBatchDownloadPath=function(){return"/?download_url"},t.prototype.checkCloudPath=function(t){return"string"!=typeof t?"必须为字符串":(t=t.trim())?t.startsWith("/")?"不能以 / 开头":t.includes("//")?"不能包含连续的 /":t.length>850?"长度不能超过 850 字节":void 0:"不能为空字符串"},t.prototype.checkFileID=function(t){return"string"!=typeof t?"必须为字符串":(t=t.trim())?void 0:"不能为空字符串"},t.prototype.formatFileID=function(t){return"cloud://".concat(this.options.toEnvId,"/").concat(t.replace(/^\/+/,""))},t.prototype.getCloudPathFromFileID=function(t){var n=t.trim().replace(/^cloud:\/\//,""),e=n.indexOf("/");if(e<=0)throw h.INVALID_PARAM_ERR("fileID","不合法");var r=n.substring(0,e),o=n.substring(e+1);return r!==this.options.toEnvId&&console.warn("file ".concat(t," does not belong to env ").concat(this.options.toEnvId)),o},t.prototype.uploadFile=function(t){return Ve(this,void 0,void 0,(function(){var n,e,r,o,i,u;return Ke(this,(function(c){switch(c.label){case 0:if(n=this.checkCloudPath(t.cloudPath))throw h.INVALID_PARAM_ERR("cloudPath",n);return e=this.getUploadPath(t.cloudPath.trim()),[4,this.request({method:"GET",path:e})];case 1:return r=c.sent(),o=d.handleResponse(r),i=this.formatFileID(o.file_id),[4,this.options.fileUploader.upload({fileID:i,uploadURL:o.upload_url,fileContent:t.fileContent})];case 2:if(200!==(u=c.sent()).statusCode)throw h.STORAGE_ERR(-1,"上传文件 ".concat(o.upload_url," 失败"),r.requestID);return[2,{fileID:i,statusCode:u.statusCode}]}}))}))},t.prototype.downloadFile=function(t){return Ve(this,void 0,void 0,(function(){var n,e,r,o,i,u;return Ke(this,(function(c){switch(c.label){case 0:if(n=this.checkFileID(t.fileID))throw h.INVALID_PARAM_ERR("fileID",n);return e=this.getCloudPathFromFileID(t.fileID),r=this.getDownloadPath(e),[4,this.request({method:"GET",path:r})];case 1:return o=c.sent(),i=d.handleResponse(o),[4,this.options.fileUploader.download({fileID:t.fileID,downloadURL:i.download_url})];case 2:if(200!==(u=c.sent()).statusCode)throw h.STORAGE_ERR(-1,"下载文件 ".concat(i.download_url," 失败"),o.requestID);return[2,u]}}))}))},t.prototype.deleteFile=function(t){return Ve(this,void 0,void 0,(function(){var n,e,r,o,i,u,c,a,s,p=this;return Ke(this,(function(f){switch(f.label){case 0:if(n=Array.isArray(t)?t:t.fileList,!Array.isArray(n)||0===n.length)throw h.INVALID_PARAM_ERR("fileList","不能为空数组");for(e=[],r=0,o=n;r<o.length;r++){if(i=o[r],u=this.checkFileID(i))throw h.INVALID_PARAM_ERR("fileID",u);c=this.getCloudPathFromFileID(i),e.push(c)}return a=this.getBatchDeletePath(),[4,this.request({method:"POST",path:a,data:{file_list:e}})];case 1:return s=f.sent(),[2,{fileList:d.handleResponse(s).file_list.map((function(t){return{fileID:p.formatFileID(t.file_id),status:t.status?0:-1,errMsg:t.status?"ok":t.result_message}}))}]}}))}))},t.prototype.getTempFileURL=function(t){return Ve(this,void 0,void 0,(function(){var n,e,r,o,i,u,c,a,s,p=this;return Ke(this,(function(f){switch(f.label){case 0:if(n=Array.isArray(t)?t:t.fileList,!Array.isArray(n)||0===n.length)throw h.INVALID_PARAM_ERR("fileList","不能为空数组");if(n.length>50)throw h.INVALID_PARAM_ERR("fileList","最大长度 50");for(e=[],r=0,o=n;r<o.length;r++){if(i=o[r],u=this.checkFileID(i))throw h.INVALID_PARAM_ERR("fileID",u);c=this.getCloudPathFromFileID(i),e.push({file_id:c,expire:600})}return a=this.getBatchDownloadPath(),[4,this.request({method:"POST",path:a,data:{file_list:e}})];case 1:return s=f.sent(),[2,{fileList:d.handleResponse(s).file_list.map((function(t){return{fileID:p.formatFileID(t.file_id),tempFileURL:t.download_url,status:t.status?0:-1,errMsg:t.status?"ok":t.result_message}}))}]}}))}))},t.prototype.request=function(t){var n=t.method,e=t.path,r=t.data,o=t.headers;return Ve(this,void 0,void 0,(function(){return Ke(this,(function(t){switch(t.label){case 0:return[4,this.options.httpclient.request({method:n,path:e,data:r,headers:We({"x-alipay-cloud-mode":"oss","x-data-api-type":"oss","x-expire-timestamp":"".concat(Date.now()+6e4)},o)})];case 1:return[2,t.sent()]}}))}))},t}(),Ge=function(){function t(){}return t.createCallFunction=function(t){return function(t){var n=t.httpclient;return y((function(t){return m(void 0,void 0,void 0,(function(){var e,r,o,i,u;return g(this,(function(c){switch(c.label){case 0:if(!t.name)throw h.INVALID_PARAM_ERR("name","缺失");return e={"x-to-function-name":t.name,"x-alipay-cloud-mode":"function"},[4,n.request({method:"POST",path:"/functions/invokeFunction",data:t.data,headers:e})];case 1:if(200!==(r=c.sent()).status)throw o=-1,i="",(u=r.data)&&(o=u.errCode,i=u.errMsg,u.errDetail&&(i+="，详情：".concat(u.errDetail))),h.SERVER_ERR(o,i,r.requestID,r.status);return[2,{requestID:r.requestID,result:r.data}]}}))}))}))}(t)},t.createCallContainer=function(t){return function(t){return y((function(n){return v(void 0,void 0,void 0,(function(){return w(this,(function(e){throw new Error("not implemented in "+t.type+" with "+n)}))}))}))}(t)},t.createDatabase=function(t){return new He(t)},t.createStorage=function(t){return new ze(t)},t}();!function(t){t.WEB="WEB",t.ALIPAY_MINI="ALIPAY_MINI",t.WEICHAT_MINI="WEICHAT_MINI"}(ge||(ge={}));var Je="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Ye(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Qe={exports:{}};var Xe,Ze={exports:{}};function tr(){return Xe||(Xe=1,function(t,n){var e;t.exports=(e=e||function(t,n){var e;if("undefined"!=typeof window&&window.crypto&&(e=window.crypto),"undefined"!=typeof self&&self.crypto&&(e=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(e=globalThis.crypto),!e&&"undefined"!=typeof window&&window.msCrypto&&(e=window.msCrypto),!e&&void 0!==Je&&Je.crypto&&(e=Je.crypto),!e)try{e=require("crypto")}catch(t){}var r=function(){if(e){if("function"==typeof e.getRandomValues)try{return e.getRandomValues(new Uint32Array(1))[0]}catch(t){}if("function"==typeof e.randomBytes)try{return e.randomBytes(4).readInt32LE()}catch(t){}}throw new Error("Native crypto module could not be used to get secure random number.")},o=Object.create||function(){function t(){}return function(n){var e;return t.prototype=n,e=new t,t.prototype=null,e}}(),i={},u=i.lib={},c=u.Base={extend:function(t){var n=o(this);return t&&n.mixIn(t),n.hasOwnProperty("init")&&this.init!==n.init||(n.init=function(){n.$super.init.apply(this,arguments)}),n.init.prototype=n,n.$super=this,n},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var n in t)t.hasOwnProperty(n)&&(this[n]=t[n]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},a=u.WordArray=c.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=e!=n?e:4*t.length},toString:function(t){return(t||p).stringify(this)},concat:function(t){var n=this.words,e=t.words,r=this.sigBytes,o=t.sigBytes;if(this.clamp(),r%4)for(var i=0;i<o;i++){var u=e[i>>>2]>>>24-i%4*8&255;n[r+i>>>2]|=u<<24-(r+i)%4*8}else for(var c=0;c<o;c+=4)n[r+c>>>2]=e[c>>>2];return this.sigBytes+=o,this},clamp:function(){var n=this.words,e=this.sigBytes;n[e>>>2]&=4294967295<<32-e%4*8,n.length=t.ceil(e/4)},clone:function(){var t=c.clone.call(this);return t.words=this.words.slice(0),t},random:function(t){for(var n=[],e=0;e<t;e+=4)n.push(r());return new a.init(n,t)}}),s=i.enc={},p=s.Hex={stringify:function(t){for(var n=t.words,e=t.sigBytes,r=[],o=0;o<e;o++){var i=n[o>>>2]>>>24-o%4*8&255;r.push((i>>>4).toString(16)),r.push((15&i).toString(16))}return r.join("")},parse:function(t){for(var n=t.length,e=[],r=0;r<n;r+=2)e[r>>>3]|=parseInt(t.substr(r,2),16)<<24-r%8*4;return new a.init(e,n/2)}},f=s.Latin1={stringify:function(t){for(var n=t.words,e=t.sigBytes,r=[],o=0;o<e;o++){var i=n[o>>>2]>>>24-o%4*8&255;r.push(String.fromCharCode(i))}return r.join("")},parse:function(t){for(var n=t.length,e=[],r=0;r<n;r++)e[r>>>2]|=(255&t.charCodeAt(r))<<24-r%4*8;return new a.init(e,n)}},l=s.Utf8={stringify:function(t){try{return decodeURIComponent(escape(f.stringify(t)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(t){return f.parse(unescape(encodeURIComponent(t)))}},h=u.BufferedBlockAlgorithm=c.extend({reset:function(){this._data=new a.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=l.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(n){var e,r=this._data,o=r.words,i=r.sigBytes,u=this.blockSize,c=i/(4*u),s=(c=n?t.ceil(c):t.max((0|c)-this._minBufferSize,0))*u,p=t.min(4*s,i);if(s){for(var f=0;f<s;f+=u)this._doProcessBlock(o,f);e=o.splice(0,s),r.sigBytes-=p}return new a.init(e,p)},clone:function(){var t=c.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});u.Hasher=h.extend({cfg:c.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){h.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(t){return function(n,e){return new t.init(e).finalize(n)}},_createHmacHelper:function(t){return function(n,e){return new y.HMAC.init(t,e).finalize(n)}}});var y=i.algo={};return i}(Math),e)}(Ze)),Ze.exports}!function(t,n){t.exports=tr().enc.Hex}(Qe);var nr=Ye(Qe.exports),er={exports:{}},rr={exports:{}};!function(t,n){var e;t.exports=(e=tr(),function(t){var n=e,r=n.lib,o=r.WordArray,i=r.Hasher,u=n.algo,c=[],a=[];!function(){function n(n){for(var e=t.sqrt(n),r=2;r<=e;r++)if(!(n%r))return!1;return!0}function e(t){return 4294967296*(t-(0|t))|0}for(var r=2,o=0;o<64;)n(r)&&(o<8&&(c[o]=e(t.pow(r,.5))),a[o]=e(t.pow(r,1/3)),o++),r++}();var s=[],p=u.SHA256=i.extend({_doReset:function(){this._hash=new o.init(c.slice(0))},_doProcessBlock:function(t,n){for(var e=this._hash.words,r=e[0],o=e[1],i=e[2],u=e[3],c=e[4],p=e[5],f=e[6],l=e[7],h=0;h<64;h++){if(h<16)s[h]=0|t[n+h];else{var y=s[h-15],d=(y<<25|y>>>7)^(y<<14|y>>>18)^y>>>3,v=s[h-2],w=(v<<15|v>>>17)^(v<<13|v>>>19)^v>>>10;s[h]=d+s[h-7]+w+s[h-16]}var m=r&o^r&i^o&i,g=(r<<30|r>>>2)^(r<<19|r>>>13)^(r<<10|r>>>22),b=l+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&p^~c&f)+a[h]+s[h];l=f,f=p,p=c,c=u+b|0,u=i,i=o,o=r,r=b+(g+m)|0}e[0]=e[0]+r|0,e[1]=e[1]+o|0,e[2]=e[2]+i|0,e[3]=e[3]+u|0,e[4]=e[4]+c|0,e[5]=e[5]+p|0,e[6]=e[6]+f|0,e[7]=e[7]+l|0},_doFinalize:function(){var n=this._data,e=n.words,r=8*this._nDataBytes,o=8*n.sigBytes;return e[o>>>5]|=128<<24-o%32,e[14+(o+64>>>9<<4)]=t.floor(r/4294967296),e[15+(o+64>>>9<<4)]=r,n.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=i.clone.call(this);return t._hash=this._hash.clone(),t}});n.SHA256=i._createHelper(p),n.HmacSHA256=i._createHmacHelper(p)}(Math),e.SHA256)}(rr);var or,ir=rr.exports,ur=Ye(ir),cr={exports:{}};!function(t,n){var e;t.exports=(e=tr(),or||(or=1,function(t,n){var e;t.exports=(e=tr(),void function(){var t=e,n=t.lib.Base,r=t.enc.Utf8;t.algo.HMAC=n.extend({init:function(t,n){t=this._hasher=new t.init,"string"==typeof n&&(n=r.parse(n));var e=t.blockSize,o=4*e;n.sigBytes>o&&(n=t.finalize(n)),n.clamp();for(var i=this._oKey=n.clone(),u=this._iKey=n.clone(),c=i.words,a=u.words,s=0;s<e;s++)c[s]^=1549556828,a[s]^=909522486;i.sigBytes=u.sigBytes=o,this.reset()},reset:function(){var t=this._hasher;t.reset(),t.update(this._iKey)},update:function(t){return this._hasher.update(t),this},finalize:function(t){var n=this._hasher,e=n.finalize(t);return n.reset(),n.finalize(this._oKey.clone().concat(e))}})}())}(cr)),e.HmacSHA256)}(er);var ar=Ye(er.exports),sr=function(){function t(){}return t.sign=function(n){for(var e=n.signedHeaders.join(";"),r="",o=0,i=n.signedHeaders;o<i.length;o++){var u=i[o],c=n.headers[u];r+="".concat(u,":").concat(c,"\n")}var a=t.createHash(n.body||""),s=n.method.toUpperCase()+"\n"+n.path+"\n"+n.query+"\n"+r+"\n"+e+"\n"+a+"\n",p="HMAC-SHA256",f=t.createHash(s),l="".concat(p,"\n").concat(n.timestamp,"\n").concat(f,"\n"),h=t.createSha256(l,n.secretKey);return"".concat(p," Credential=").concat(n.secretId,", SignedHeaders=").concat(e,", Signature=").concat(h)},t.createSha256=function(t,n){return void 0===n&&(n=""),ar(t,n).toString(nr)},t.createHash=function(t){return ur(t).toString(nr)},t}(),pr=function(){function t(){}return t.detectRuntime=function(){return window||void 0===("undefined"==typeof my?"undefined":n(my))?window||void 0===("undefined"==typeof wx?"undefined":n(wx))?ge.WEB:ge.WEICHAT_MINI:ge.ALIPAY_MINI},t.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var n=16*Math.random()|0;return("x"==t?n:3&n|8).toString(16)}))},t.parseUrl=function(t,n){if(n===ge.WEB)return new URL(t);var e=t.match(/^(https?):\/\/([^/]+)(\/[^?]+)?(\?[^#]+)?/)||[],r=e[1],o=e[2],i=e[3],u=e[4];return{protocol:r||"",host:o||"",pathname:"".concat(i||""),search:u||""}},t}();var fr=function(){function t(t,n){this.req=t,this.config=n}return Object.defineProperty(t.prototype,"requestId",{get:function(){return this.req.requestOptions.headers["x-trace-id"]},enumerable:!1,configurable:!0}),t}(),lr=function(){function t(){}return t.prototype.request=function(t,n){return o(this,void 0,void 0,(function(){var e,o,u;return i(this,(function(i){switch(i.label){case 0:return[4,fetch(t,r({mode:"cors"},n))];case 1:return e=i.sent(),o={},e.headers.forEach((function(t,n){o[n]=t})),u={status:e.status},[4,e.json()];case 2:return[2,(u.data=i.sent(),u.headers=o,u)]}}))}))},t}(),hr=function(){function t(){}return t.prototype.request=function(t,n){return o(this,void 0,void 0,(function(){var e;return i(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,my.request({url:t,method:(null==n?void 0:n.method)||"GET",data:null==n?void 0:n.body,headers:null==n?void 0:n.headers,dataType:"json"})];case 1:return[2,r.sent()];case 2:throw e=r.sent(),console.error(e),new Error("error: ".concat(e.error,", message: ").concat(e.errorMessage));case 3:return[2]}}))}))},t}(),yr=function(){function t(){}return t.prototype.request=function(t,n){return o(this,void 0,void 0,(function(){return i(this,(function(e){return[2,new Promise((function(e,r){wx.request({url:t,method:(null==n?void 0:n.method)||"GET",data:null==n?void 0:n.body,header:null==n?void 0:n.headers,dataType:"json",success:function(t){e({status:t.statusCode,data:t.data,headers:t.header})},reject:function(t){r(new Error("error: ".concat(t.errno,", message: ").concat(t.errMsg)))}})}))]}))}))},t}(),dr=function(){function t(){}return t.default=function(t){if(!this.singleton)switch(t){case ge.ALIPAY_MINI:this.singleton=new hr;break;case ge.WEB:this.singleton=new lr;break;case ge.WEICHAT_MINI:this.singleton=new yr;break;default:throw new Error("未知运行环境".concat(t))}return this.singleton},t}();function vr(t,n){return o(this,void 0,void 0,(function(){var e,r;return i(this,(function(o){switch(o.label){case 0:return[4,n()];case 1:return o.sent(),e=t.config.fetch||dr.default(t.config.runtime),r=t,[4,e.request(t.req.url,t.req.requestOptions)];case 2:return r.res=o.sent(),t.result={status:t.res.status,requestID:t.requestId,headers:t.res.headers,data:t.res.data},[2]}}))}))}function wr(t,n){return o(this,void 0,void 0,(function(){var e;return i(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,n()];case 1:return r.sent(),[3,3];case 2:throw e=r.sent(),h.NETWORK_ERR(e,t.requestId);case 3:return[2]}}))}))}function mr(t){return function(n,e){return o(this,void 0,void 0,(function(){var o,u,c,a,s;return i(this,(function(i){switch(i.label){case 0:return o=Date.now(),u=pr.parseUrl(n.req.url,n.config.runtime),c={authorization:"","x-from-app-id":n.config.appId,"x-from-env-id":n.config.envId,"x-to-env-id":n.config.envId,"x-from-instance-id":"".concat(o),"x-from-function-name":n.config.functionName,"x-client-timestamp":"".concat(o)},t.length>0&&t.forEach((function(t){var e,r=null===(e=n.req.requestOptions.headers)||void 0===e?void 0:e[t];r&&(c[t]=r)})),a=function(t,n,e){if(e||2===arguments.length)for(var r,o=0,i=n.length;o<i;o++)!r&&o in n||(r||(r=Array.prototype.slice.call(n,0,o)),r[o]=n[o]);return t.concat(r||Array.prototype.slice.call(n))}(["x-from-app-id","x-from-env-id","x-from-instance-id","x-from-function-name","x-client-timestamp","x-to-env-id"],t,!0).sort(),s={path:u.pathname,query:u.search.substring(1),secretId:n.config.secretId,secretKey:n.config.secretKey,method:n.req.requestOptions.method,headers:c,body:n.req.requestOptions.body,timestamp:o,signedHeaders:a},c.authorization=sr.sign(s),n.req.requestOptions.headers=r(r({},c),n.req.requestOptions.headers),[4,e()];case 1:return i.sent(),[2]}}))}))}}var gr=function(){function t(t,n){var e;this.config=t,this.handler=(e=n,function(t,n){var r=-1;return function o(i){if(i<=r)return Promise.reject(new Error("next() called multiple times"));r=i;var u=e[i];if(i===e.length&&(u=n),!u)return Promise.resolve();try{return Promise.resolve(u(t,o.bind(null,i+1)))}catch(t){return Promise.reject(t)}}(0)})}return t.prototype.request=function(t){var n=t.method,e=t.path,r=t.data,u=t.headers;return o(this,void 0,void 0,(function(){var t,o,c,a;return i(this,(function(i){switch(i.label){case 0:return t=this.config.endpoint+e,o=r?JSON.stringify(r):r,c=pr.generateUUID(),u=Object.assign({"x-alipay-callid":c,"x-request-id":c,"x-alipay-source":"web,web-sdk","content-type":"application/json"},u),a=new fr({url:t,requestOptions:{method:n,body:o,headers:u}},this.config),[4,this.handler(a)];case 1:return i.sent(),[2,a.result]}}))}))},t.createFunctionHttpclient=function(n){return new t(n,[wr,mr(["x-to-function-name"]),vr])},t.createDatabaseHttpclient=function(n){return new t(n,[wr,mr(["x-data-api-type","x-expire-timestamp"]),vr])},t.createStorageHttpclient=function(n){return new t(n,[wr,mr(["x-data-api-type","x-expire-timestamp"]),vr])},t}(),br=function(){function t(){}return t.prototype.upload=function(t){return o(this,void 0,void 0,(function(){var n,e;return i(this,(function(r){switch(r.label){case 0:return n=t.uploadURL,e=t.fileContent,[4,fetch(n,{method:"PUT",mode:"cors",body:e})];case 1:return[2,{statusCode:r.sent().status}]}}))}))},t.prototype.download=function(t){return o(this,void 0,void 0,(function(){return i(this,(function(n){return[2,{fileContent:t.downloadURL,statusCode:200}]}))}))},t.create=function(){return t.instance||(t.instance=new t),t.instance},t}(),_r=function(t){function n(e){var r=gr.createStorageHttpclient(e),o=n.getFileUploader(e);return t.call(this,{httpclient:r,fileUploader:o,type:"web",toEnvId:e.envId})||this}return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}(n,t),n.getFileUploader=function(t){if(t.fileUploader)return t.fileUploader;if(t.runtime===ge.WEB)return br.create();throw h.INVALID_PARAM_ERR("fileUploader","未指定文件上传/下载实现")},n}(ze),Or=function(){function t(t){var n=t.resourceEnv||t.envId,e=t.resourceAppid||t.appId;this.config={endpoint:t.endpoint||"https://".concat(n,".api-hz.cloudbasefunction.cn"),secretId:t.secretId,secretKey:t.secretKey,appId:e,envId:n,fetch:t.fetch,fileUploader:t.fileUploader,runtime:t.runtime||pr.detectRuntime(),functionName:""}}return t.prototype.init=function(){},t.prototype.callFunction=function(t){var n;return o(this,void 0,void 0,(function(){var e,o;return i(this,(function(i){switch(i.label){case 0:return e=r(r({},this.config),{envId:(null===(n=t.config)||void 0===n?void 0:n.env)||this.config.envId,functionName:t.name}),o=gr.createFunctionHttpclient(e),[4,Ge.createCallFunction({type:"web",httpclient:o})(t)];case 1:return[2,i.sent()]}}))}))},t.prototype.getStorage=function(){return this.storage||(this.storage=new _r(this.config)),this.storage},t.prototype.uploadFile=function(t){return o(this,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,this.getStorage().uploadFile(t)];case 1:return[2,n.sent()]}}))}))},t.prototype.downloadFile=function(t){return o(this,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,this.getStorage().downloadFile(t)];case 1:return[2,n.sent()]}}))}))},t.prototype.deleteFile=function(t){return o(this,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,this.getStorage().deleteFile(t)];case 1:return[2,n.sent()]}}))}))},t.prototype.getTempFileURL=function(t){return o(this,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,this.getStorage().getTempFileURL(t)];case 1:return[2,n.sent()]}}))}))},t.RUNTIME=ge,t}();t.Cloud=Or}));

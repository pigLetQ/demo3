var w=function(){w=Object.assign||function(a){for(var e,r=1,o=arguments.length;r<o;r++){e=arguments[r];for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n))a[n]=e[n]}return a};return w.apply(this,arguments)};var I=function(a,e,r,o){function n(t){return t instanceof r?t:new r(function(s){s(t)})}return new(r||(r=Promise))(function(t,s){function l(h){try{i(o.next(h))}catch(d){s(d)}}function u(h){try{i(o["throw"](h))}catch(d){s(d)}}function i(h){h.done?t(h.value):n(h.value).then(l,u)}i((o=o.apply(a,e||[])).next())})};var R=function(a,e){var r={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},o,n,t,s;return s={next:l(0),"throw":l(1),"return":l(2)},typeof Symbol==="function"&&(s[Symbol.iterator]=function(){return this}),s;function l(i){return function(h){return u([i,h])}}function u(i){if(o)throw new TypeError("Generator is already executing.");while(s&&(s=0,i[0]&&(r=0)),r)try{if(o=1,n&&(t=i[0]&2?n["return"]:i[0]?n["throw"]||((t=n["return"])&&t.call(n),0):n.next)&&!(t=t.call(n,i[1])).done)return t;if(n=0,t)i=[i[0]&2,t.value];switch(i[0]){case 0:case 1:t=i;break;case 4:r.label++;return{value:i[1],done:false};case 5:r.label++;n=i[1];i=[0];continue;case 7:i=r.ops.pop();r.trys.pop();continue;default:if(!(t=r.trys,t=t.length>0&&t[t.length-1])&&(i[0]===6||i[0]===2)){r=0;continue}if(i[0]===3&&(!t||i[1]>t[0]&&i[1]<t[3])){r.label=i[1];break}if(i[0]===6&&r.label<t[1]){r.label=t[1];t=i;break}if(t&&r.label<t[2]){r.label=t[2];r.ops.push(i);break}if(t[2])r.ops.pop();r.trys.pop();continue}i=e.call(a,r)}catch(h){i=[6,h];n=0}finally{o=t=0}if(i[0]&5)throw i[1];return{value:i[0]?i[1]:void 0,done:true}}};import{FaasError as f}from"./error";import{ResponseUtil as _}from"./utils";var y=function(){function a(e){this.options=e}a.prototype.getUploadPath=function(e){return"/".concat(e,"?upload_url")};a.prototype.getDownloadPath=function(e){return"/".concat(e,"?download_url&expire=3600")};a.prototype.getBatchDeletePath=function(){return"/?delete"};a.prototype.getBatchDownloadPath=function(){return"/?download_url"};a.prototype.checkCloudPath=function(e){if(typeof e!=="string")return"\u5FC5\u987B\u4E3A\u5B57\u7B26\u4E32";e=e.trim();if(!e)return"\u4E0D\u80FD\u4E3A\u7A7A\u5B57\u7B26\u4E32";if(e.startsWith("/"))return"\u4E0D\u80FD\u4EE5 / \u5F00\u5934";if(e.includes("//"))return"\u4E0D\u80FD\u5305\u542B\u8FDE\u7EED\u7684 /";if(e.length>850)return"\u957F\u5EA6\u4E0D\u80FD\u8D85\u8FC7 850 \u5B57\u8282"};a.prototype.checkFileID=function(e){if(typeof e!=="string")return"\u5FC5\u987B\u4E3A\u5B57\u7B26\u4E32";e=e.trim();if(!e)return"\u4E0D\u80FD\u4E3A\u7A7A\u5B57\u7B26\u4E32"};a.prototype.formatFileID=function(e){return"cloud://".concat(this.options.toEnvId,"/").concat(e.replace(/^\/+/,""))};a.prototype.getCloudPathFromFileID=function(e){var r=e.trim().replace(/^cloud:\/\//,"");var o=r.indexOf("/");if(o<=0){throw f.INVALID_PARAM_ERR("fileID","\u4E0D\u5408\u6CD5")}var n=r.substring(0,o);var t=r.substring(o+1);if(n!==this.options.toEnvId){console.warn("file ".concat(e," does not belong to env ").concat(this.options.toEnvId))}return t};a.prototype.uploadFile=function(e){return I(this,void 0,void 0,function(){var r,o,n,t,s,l;return R(this,function(u){switch(u.label){case 0:r=this.checkCloudPath(e.cloudPath);if(r){throw f.INVALID_PARAM_ERR("cloudPath",r)}o=this.getUploadPath(e.cloudPath.trim());return[4,this.request({method:"GET",path:o})];case 1:n=u.sent();t=_.handleResponse(n);s=this.formatFileID(t.file_id);return[4,this.options.fileUploader.upload({fileID:s,uploadURL:t.upload_url,fileContent:e.fileContent})];case 2:l=u.sent();if(l.statusCode!==200){throw f.STORAGE_ERR(-1,"\u4E0A\u4F20\u6587\u4EF6 ".concat(t.upload_url," \u5931\u8D25"),n.requestID)}return[2,{fileID:s,statusCode:l.statusCode}]}})})};a.prototype.downloadFile=function(e){return I(this,void 0,void 0,function(){var r,o,n,t,s,l;return R(this,function(u){switch(u.label){case 0:r=this.checkFileID(e.fileID);if(r){throw f.INVALID_PARAM_ERR("fileID",r)}o=this.getCloudPathFromFileID(e.fileID);n=this.getDownloadPath(o);return[4,this.request({method:"GET",path:n})];case 1:t=u.sent();s=_.handleResponse(t);return[4,this.options.fileUploader.download({fileID:e.fileID,downloadURL:s.download_url})];case 2:l=u.sent();if(l.statusCode!==200){throw f.STORAGE_ERR(-1,"\u4E0B\u8F7D\u6587\u4EF6 ".concat(s.download_url," \u5931\u8D25"),t.requestID)}return[2,l]}})})};a.prototype.deleteFile=function(e){return I(this,void 0,void 0,function(){var r,o,n,t,s,l,u,i,h,d;var g=this;return R(this,function(p){switch(p.label){case 0:r=Array.isArray(e)?e:e.fileList;if(!Array.isArray(r)||r.length===0){throw f.INVALID_PARAM_ERR("fileList","\u4E0D\u80FD\u4E3A\u7A7A\u6570\u7EC4")}o=[];for(n=0,t=r;n<t.length;n++){s=t[n];l=this.checkFileID(s);if(l){throw f.INVALID_PARAM_ERR("fileID",l)}u=this.getCloudPathFromFileID(s);o.push(u)}i=this.getBatchDeletePath();return[4,this.request({method:"POST",path:i,data:{file_list:o}})];case 1:h=p.sent();d=_.handleResponse(h);return[2,{fileList:d.file_list.map(function(c){return{fileID:g.formatFileID(c.file_id),status:c.status?0:-1,errMsg:c.status?"ok":c.result_message}})}]}})})};a.prototype.getTempFileURL=function(e){return I(this,void 0,void 0,function(){var r,o,n,t,s,l,u,i,h,d;var g=this;return R(this,function(p){switch(p.label){case 0:r=Array.isArray(e)?e:e.fileList;if(!Array.isArray(r)||r.length===0){throw f.INVALID_PARAM_ERR("fileList","\u4E0D\u80FD\u4E3A\u7A7A\u6570\u7EC4")}if(r.length>50){throw f.INVALID_PARAM_ERR("fileList","\u6700\u5927\u957F\u5EA6 50")}o=[];for(n=0,t=r;n<t.length;n++){s=t[n];l=this.checkFileID(s);if(l){throw f.INVALID_PARAM_ERR("fileID",l)}u=this.getCloudPathFromFileID(s);o.push({file_id:u,expire:600})}i=this.getBatchDownloadPath();return[4,this.request({method:"POST",path:i,data:{file_list:o}})];case 1:h=p.sent();d=_.handleResponse(h);return[2,{fileList:d.file_list.map(function(c){return{fileID:g.formatFileID(c.file_id),tempFileURL:c.download_url,status:c.status?0:-1,errMsg:c.status?"ok":c.result_message}})}]}})})};a.prototype.request=function(e){var r=e.method,o=e.path,n=e.data,t=e.headers;return I(this,void 0,void 0,function(){return R(this,function(s){switch(s.label){case 0:return[4,this.options.httpclient.request({method:r,path:o,data:n,headers:w({"x-alipay-cloud-mode":"oss","x-data-api-type":"oss","x-expire-timestamp":"".concat(Date.now()+6e4)},t)})];case 1:return[2,s.sent()]}})})};return a}();export{y as Storage};
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.signMiddlewareFactory=void 0;const faas_server_utils_1=require("@alipay/faas-server-utils");function signMiddlewareFactory(t){return async function(e,s){const r=(0,faas_server_utils_1.getAlipayContext)(),i=Date.now(),n={authorization:"","x-from-app-id":r.APPID,"x-from-env-id":e.config.fromEnvId,"x-to-env-id":e.config.toEnvId,"x-from-instance-id":e.config.functionInstanceId,"x-from-function-name":e.config.functionName,"x-client-timestamp":`${i}`,"x-trace-id":r.TRACEID,"sofa-rpcid":`${r.RPCID}.${++r.rpcCount}`};t.length>0&&t.forEach(o=>{n[o]=e.req.requestOptions.headers?.[o]});const a=["x-from-app-id","x-from-env-id","x-from-instance-id","x-from-function-name","x-client-timestamp","x-to-env-id",...t].sort(),d={path:e.req.url.pathname,query:e.req.url.search.substring(1),secretId:e.config.secretId,secretKey:e.config.secretKey,method:e.req.requestOptions.method,headers:n,body:e.req.requestOptions.content,timestamp:i,signedHeaders:a};n.authorization=(0,faas_server_utils_1.sign)(d),e.req.requestOptions.headers={...n,...e.req.requestOptions.headers},await s()}}exports.signMiddlewareFactory=signMiddlewareFactory;
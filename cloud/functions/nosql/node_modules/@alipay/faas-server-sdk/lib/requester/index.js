"use strict";var __importDefault=this&&this.__importDefault||function(a){return a&&a.__esModule?a:{default:a}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Httpclient=void 0;const node_assert_1=__importDefault(require("node:assert")),node_crypto_1=require("node:crypto"),node_diagnostics_channel_1=__importDefault(require("node:diagnostics_channel")),koa_compose_1=__importDefault(require("koa-compose")),faas_server_utils_1=require("@alipay/faas-server-utils"),constant_1=require("../constant"),HttpRequestContext_1=require("./HttpRequestContext"),call_middleware_1=require("./middlewares/call_middleware"),error_handler_middleware_1=require("./middlewares/error_handler_middleware"),init_call_dataproxy_headers_middleware_1=require("./middlewares/init_call_dataproxy_headers_middleware"),init_call_functiongateway_headers_middleware_1=require("./middlewares/init_call_functiongateway_headers_middleware"),sign_middleware_factory_1=require("./middlewares/sign_middleware_factory"),debug=(0,faas_server_utils_1.debuglog)("faas-server-sdk:httpRequest");class Httpclient{#t;#e;#r;constructor(t,e,r){(0,node_assert_1.default)(e,"cloud config not set"),this.#t=t,this.#e=e,this.#r=(0,koa_compose_1.default)(r)}async request(t){return(await this.requestRaw(t)).result}async requestRaw({method:t,path:e,data:r,headers:s}){const d=this.#e[this.#t]+e,c=r&&JSON.stringify(r),n=(0,faas_server_utils_1.getAlipayContext)();s=s||{},s["x-alipay-callid"]=s["x-request-id"]=n.TRACEID||(0,node_crypto_1.randomUUID)();let i=process.env.RUNTIME_CURRENT_SOURCE||"alipay_unknown";process.env.RUNTIME_FUNCTION_NAME&&(i=`${i}:${n.ENV}:${process.env.RUNTIME_FUNCTION_NAME}`);const u=n.SOURCE||"alipay_unknown";s["x-alipay-source"]=`${u},${i}`,s["user-agent"]=constant_1.SDK_USER_AGENT;const o={method:t,contentType:"application/json",content:c,dataType:"json",headers:s};this.#e.timeout!==void 0&&(o.timeout=this.#e.timeout),debug("requestRaw(url:%o, options:%o)",d,o);const _={url:new URL(d),requestOptions:o},l=new HttpRequestContext_1.HttpRequestContext(_,this.#e);return await this.#r(l),l}static createFunctionHttpclient(t){const e=[error_handler_middleware_1.errorHandlerMiddleware,(0,init_call_functiongateway_headers_middleware_1.createInitCallFunctionGatewayHeadersMiddleware)(),(0,sign_middleware_factory_1.signMiddlewareFactory)(["x-to-function-name"]),call_middleware_1.callMiddleware];return new Httpclient("functionGatewayEndpoint",t,e)}static createDatabaseHttpclient(t){const e=[error_handler_middleware_1.errorHandlerMiddleware,(0,init_call_dataproxy_headers_middleware_1.createInitCallDataProxyHeadersMiddleware)("mongo"),(0,sign_middleware_factory_1.signMiddlewareFactory)(["x-data-api-type","x-expire-timestamp"]),call_middleware_1.callMiddleware];return new Httpclient("functionDatabaseEndpoint",t,e)}static createStorageHttpclient(t){const e=[error_handler_middleware_1.errorHandlerMiddleware,(0,init_call_dataproxy_headers_middleware_1.createInitCallDataProxyHeadersMiddleware)("oss"),(0,sign_middleware_factory_1.signMiddlewareFactory)(["x-data-api-type","x-expire-timestamp"]),call_middleware_1.callMiddleware];return new Httpclient("functionStorageEndpoint",t,e)}static createOpenapiHttpclient(t){const e=[error_handler_middleware_1.errorHandlerMiddleware,(0,init_call_functiongateway_headers_middleware_1.createInitCallFunctionGatewayHeadersMiddleware)(),(0,sign_middleware_factory_1.signMiddlewareFactory)(["x-openapi","x-openapi-version"]),call_middleware_1.callMiddleware];return new Httpclient("functionGatewayEndpoint",t,e)}}exports.Httpclient=Httpclient,debug.enabled&&(node_diagnostics_channel_1.default.subscribe("urllib:request",a=>{const{request:t}=a;debug("[urllib:request] request#%s %s %o, headers: %o",t.requestId,t.args.method,t.url,t.args.headers)}),node_diagnostics_channel_1.default.subscribe("urllib:response",a=>{const{request:t,response:e,error:r}=a;debug("[urllib:response] request#%s got response %s, status: %o, size: %o, headers: %o, rt: %o, timing: %o, socket: %o, requestUrls: %o",t.requestId,r?"error":"success",e.status,e.size,e.headers,e.rt,e.timing,e.socket,e.requestUrls),r&&debug("[urllib:response] %s",r)}));
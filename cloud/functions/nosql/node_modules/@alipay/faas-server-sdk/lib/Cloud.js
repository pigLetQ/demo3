"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Cloud=exports.initRuntimeEnv=void 0;const faas_server_utils_1=require("@alipay/faas-server-utils"),callFunction_1=require("./callFunction"),constant_1=require("./constant"),Database_1=require("./Database"),MySQL_1=require("./MySQL"),Openapi_1=require("./Openapi"),Storage_1=require("./Storage"),utils_1=require("./utils"),runtimeEnv={RUNTIME_ACCESS_KEY:process.env.RUNTIME_ACCESS_KEY||"",RUNTIME_SECRET_KEY:process.env.RUNTIME_SECRET_KEY||"",RUNTIME_ENV_ID:process.env.RUNTIME_ENV_ID||"",RUNTIME_FUNCTION_NAME:process.env.RUNTIME_FUNCTION_NAME||"",RUNTIME_FUNCTION_GATEWAY_ENDPOINT:process.env.RUNTIME_FUNCTION_GATEWAY_ENDPOINT||"",RUNTIME_FUNCTION_INSTANCE_ID:process.env.RUNTIME_FUNCTION_INSTANCE_ID||"",RUNTIME_MONGO_CLUSTER_ENDPOINT:process.env.RUNTIME_MONGO_CLUSTER_ENDPOINT||"",RUNTIME_MONGO_DATABASE_NAME:process.env.RUNTIME_MONGO_DATABASE_NAME||"",RUNTIME_OSS_ENDPOINT:process.env.RUNTIME_OSS_ENDPOINT||"",RUNTIME_MYSQL_ENDPOINT:process.env.RUNTIME_MYSQL_ENDPOINT||""};function initRuntimeEnv(N){Object.assign(runtimeEnv,N)}exports.initRuntimeEnv=initRuntimeEnv;class Cloud{#t;#e;#N;#n;#i;constructor(){this.#t={secretId:runtimeEnv.RUNTIME_ACCESS_KEY,secretKey:runtimeEnv.RUNTIME_SECRET_KEY,fromEnvId:runtimeEnv.RUNTIME_ENV_ID,toEnvId:runtimeEnv.RUNTIME_ENV_ID,functionName:runtimeEnv.RUNTIME_FUNCTION_NAME,functionGatewayEndpoint:runtimeEnv.RUNTIME_FUNCTION_GATEWAY_ENDPOINT,functionInstanceId:runtimeEnv.RUNTIME_FUNCTION_INSTANCE_ID,functionDatabaseEndpoint:runtimeEnv.RUNTIME_MONGO_CLUSTER_ENDPOINT,functionDatabaseName:runtimeEnv.RUNTIME_MONGO_DATABASE_NAME,functionStorageEndpoint:runtimeEnv.RUNTIME_OSS_ENDPOINT,functionMysqlEndpoint:runtimeEnv.RUNTIME_MYSQL_ENDPOINT,timeout:1e4}}refreshConfig(){runtimeEnv.RUNTIME_ACCESS_KEY&&(this.#t.secretId=runtimeEnv.RUNTIME_ACCESS_KEY),runtimeEnv.RUNTIME_SECRET_KEY&&(this.#t.secretKey=runtimeEnv.RUNTIME_SECRET_KEY),runtimeEnv.RUNTIME_ENV_ID&&(this.#t.fromEnvId=runtimeEnv.RUNTIME_ENV_ID,this.#t.toEnvId||(this.#t.toEnvId=runtimeEnv.RUNTIME_ENV_ID)),runtimeEnv.RUNTIME_FUNCTION_NAME&&(this.#t.functionName=runtimeEnv.RUNTIME_FUNCTION_NAME),runtimeEnv.RUNTIME_FUNCTION_GATEWAY_ENDPOINT&&(this.#t.functionGatewayEndpoint=runtimeEnv.RUNTIME_FUNCTION_GATEWAY_ENDPOINT),runtimeEnv.RUNTIME_FUNCTION_INSTANCE_ID&&(this.#t.functionInstanceId=runtimeEnv.RUNTIME_FUNCTION_INSTANCE_ID),runtimeEnv.RUNTIME_MONGO_CLUSTER_ENDPOINT&&(this.#t.functionDatabaseEndpoint=runtimeEnv.RUNTIME_MONGO_CLUSTER_ENDPOINT),runtimeEnv.RUNTIME_MONGO_DATABASE_NAME&&(this.#t.functionDatabaseName=runtimeEnv.RUNTIME_MONGO_DATABASE_NAME),runtimeEnv.RUNTIME_OSS_ENDPOINT&&(this.#t.functionStorageEndpoint=runtimeEnv.RUNTIME_OSS_ENDPOINT),runtimeEnv.RUNTIME_MYSQL_ENDPOINT&&(this.#t.functionMysqlEndpoint=runtimeEnv.RUNTIME_MYSQL_ENDPOINT)}init(t){const e=this.#_(t?.env);e&&(this.#t.toEnvId=e),t?.envId&&(this.#t.toEnvId=t.envId),t?.timeout!==void 0&&(this.#t.timeout=(0,utils_1.validateTimeout)(t.timeout))}getAlipayContext(){return(0,faas_server_utils_1.getAlipayContext)()}async callFunction(t){const{config:e,...n}=t||{},i=this.#E(e?.env);return await(0,callFunction_1.createCallFunction)(i)(n)}database(t){const e=this.#E(t?.env);return new Database_1.Database({...e,throwOnNotFound:t?.throwOnNotFound!==!1,ignoreCollectionExists:t?.ignoreCollectionExists===!0,timeout:(0,utils_1.validateTimeout)(t?.timeout??e.timeout)})}mysql(){return this.#N||(this.#N=new MySQL_1.MySQL(this.#t)),this.#N}get openapi(){return this.#n||(this.#n=(0,Openapi_1.createOpenapi)(this.#t)),this.#n}getOpenapiCaller(){return this.#i||(this.#i=(0,Openapi_1.createOpenapiCaller)(this.#t)),this.#i}getStorage(){return this.#e||(this.#e=new Storage_1.Storage(this.#t)),this.#e}async uploadFile(t){return await this.getStorage().uploadFile(t)}async downloadFile(t){return await this.getStorage().downloadFile(t)}async deleteFile(t){return await this.getStorage().deleteFile(t)}async getTempFileURL(t){return await this.getStorage().getTempFileURL(t)}#E(t){const e=this.#_(t);return e?{...this.#t,toEnvId:e}:this.#t}#_(t){return t&&typeof t=="string"?t:t&&t===constant_1.DYNAMIC_CURRENT_ENV?runtimeEnv.RUNTIME_ENV_ID:null}}exports.Cloud=Cloud;
"use strict";var __importDefault=this&&this.__importDefault||function(l){return l&&l.__esModule?l:{default:l}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MySQL=void 0;const node_diagnostics_channel_1=__importDefault(require("node:diagnostics_channel")),faas_server_utils_1=require("@alipay/faas-server-utils"),ali_rds_1=require("ali-rds"),transaction_1=require("./transaction");class MySQL{#e;#n;#s=!0;constructor(s){this.#e=s}async query(s,n){return await this.#t().query(s,n)}async insert(s,n,i){return await this.#t().insert(s,n,i)}async update(s,n,i){return await this.#t().update(s,n,i)}async select(s,n){return await this.#t().select(s,n)}async get(s,n,i){return await this.#t().get(s,n,i)}async delete(s,n){return await this.#t().delete(s,n)}async count(s,n){return await this.#t().count(s,n)}async beginTransaction(){const s=await this.#t().beginTransaction();return new transaction_1.MySQLTransaction(s)}async beginTransactionScope(s){return await this.#t().beginTransactionScope(async n=>{const i=new transaction_1.MySQLTransaction(n);return await s(i)})}#o(s=""){const n=(0,faas_server_utils_1.getAlipayContext)(),i=Date.now(),r={authorization:"","x-from-app-id":n.APPID,"x-from-env-id":this.#e.fromEnvId,"x-to-env-id":this.#e.toEnvId,"x-from-instance-id":this.#e.functionInstanceId,"x-from-function-name":this.#e.functionName,"x-client-timestamp":`${i}`,"x-trace-id":n.TRACEID},h=["x-from-app-id","x-from-env-id","x-from-instance-id","x-from-function-name","x-client-timestamp","x-to-env-id"],d={path:"",query:"",secretId:this.#e.secretId,secretKey:this.#e.secretKey,method:"POST",headers:r,body:s,timestamp:i,signedHeaders:h,isMySql:!0};r.authorization=(0,faas_server_utils_1.sign)(d);const a=[];for(const c in r){if(c==="authorization")continue;const o=r[c];a.push(`${c}:${o}`)}const u=r.authorization.split(" ");a.push(`SecAlgo:${u[0]}`);for(let c=1;c<u.length;c++){let o=u[c];o.endsWith(",")&&(o=o.substring(0,o.length-1)),a.push(o.replace(/=/g,":").replace(/,/g,";"))}return`!cloudbase:${a.join(",")}`}#t(){if(!this.#n){if(process.env.MYSQL_TEST_MODE==="test")this.#s=!1,this.#n=new ali_rds_1.RDSClient({host:process.env.MYSQL_HOST||"127.0.0.1",port:process.env.MYSQL_PORT?parseInt(process.env.MYSQL_PORT):3306,user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"faas_unittest"});else{const[s,n]=this.#e.functionMysqlEndpoint.split(":");this.#n=new ali_rds_1.RDSClient({getConnectionConfig:()=>({host:s,port:parseInt(n),user:this.#o(),password:"",database:""})})}this.#n.beforeQuery(s=>this.#s?`/*${this.#o(s)}*/${s}`:s)}return this.#n}}exports.MySQL=MySQL;const debug=(0,faas_server_utils_1.debuglog)("faas-server-sdk:mysql");if(debug.enabled){let l=0,s=0;const n=Symbol("rds client id"),i=Symbol("rds client enqueue counter"),r=Symbol("connection id"),h=Symbol("rds client create connection counter"),d=Symbol("connection acquire counter"),a=Symbol("connection release counter"),u=Symbol("connection query start counter"),c=Symbol("connection query end counter");node_diagnostics_channel_1.default.subscribe("ali-rds:connection:new",o=>{const{client:e,connection:t}=o;e[n]||(e[n]=l++),t[r]||(t[r]=s++,t[n]=e[n]),e[h]=(e[h]||0)+1,debug("[ali-rds:connection:new] client#%s create a new connection#%s (%s#%s:%s), total created %s, stats: %o",e[n],t[r],t.threadId,t.config.host,t.config.port,e[h],e.stats)}),node_diagnostics_channel_1.default.subscribe("ali-rds:connection:acquire",o=>{const{client:e,connection:t}=o;t[d]=(t[d]||0)+1,debug("[ali-rds:connection:acquire] client#%s acquire connection#%s (%s#%s:%s, acquire/release: %s/%s), stats: %o",e[n],t[r],t.threadId,t.config.host,t.config.port,t[d],t[a]||0,e.stats)}),node_diagnostics_channel_1.default.subscribe("ali-rds:connection:release",o=>{const{client:e,connection:t}=o;t[a]=(t[a]||0)+1,debug("[ali-rds:connection:release] client#%s release connection#%s (%s#%s:%s, acquire/release: %s/%s), stats: %o",e[n],t[r],t.threadId,t.config.host,t.config.port,t[d],t[a],e.stats)}),node_diagnostics_channel_1.default.subscribe("ali-rds:connection:enqueue",o=>{const{client:e}=o;e[i]=(e[i]||0)+1,debug("[ali-rds:connection:enqueue] client#%s enqueue, times: %s, stats: %o",e[n],e[i],e.stats)}),node_diagnostics_channel_1.default.subscribe("ali-rds:query:start",o=>{const{sql:e,connection:t}=o;t[u]=(t[u]||0)+1,debug("[ali-rds:query:start] client#%s connection#%s (%s#%s:%s, query: %s/%s) start query: %j",t[n],t[r],t.threadId,t.config.host,t.config.port,t[u],t[c]||0,e)}),node_diagnostics_channel_1.default.subscribe("ali-rds:query:end",o=>{const{connection:e,duration:t,error:f}=o;e[c]=(e[c]||0)+1,debug("[ali-rds:query:end] client#%s connection#%s (%s#%s:%s, query: %s/%s) end query, duration: %sms, error: %s",e[n],e[r],e.threadId,e.config.host,e.config.port,e[u],e[c],t,f)})}
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Database=void 0;const faas_db_builder_1=require("@alipay/faas-db-builder"),faas_common_sdk_1=require("@alipay/faas-common-sdk"),requester_1=require("../requester"),Collection_1=require("./Collection"),Transaction_1=require("./Transaction");class Database{#t;command;#n;#s;constructor(s){this.#t=s,this.command=new faas_db_builder_1.Command,this.#n=new faas_db_builder_1.MongoBuilder,this.#s=requester_1.Httpclient.createDatabaseHttpclient(s)}collection(s){return new Collection_1.Collection(this.#t,s,this.#s)}#i(){return`/${this.#t.functionDatabaseName||"faas"}`}#a(s){return`${this.#i()}/${s}`}async requestRaw(s,t,e,a){const{res:n}=await this.#s.requestRaw({method:s,path:t,data:e,headers:a});return n}async createCollection(s){if(this.#t.ignoreCollectionExists){const a=await this.#r(s);if(a)return a}const t="PUT",e=this.#a(s);return await this.#e(t,e)}async getCollection(s){const t="GET",e=this.#a(s);return await this.#e(t,e)}async listCollection(s,t){const e="POST",a=`${this.#i()}?list`,{options:n}=this.#n.listCollection(s,t);return await this.#e(e,a,n)}async deleteCollection(s){const t="DELETE",e=this.#a(s);return await this.#e(t,e)}async startTransaction(){return await Transaction_1.Transaction.create(this.#t,this.#s)}async runTransaction(s){const t=await this.startTransaction();try{const e=await s(t);if(t.isRollback())throw t.reason;return t.isProcessing()&&await t.commit(),e}catch(e){if(t.isProcessing())try{await t.rollback(e)}catch(a){throw a.cause=e,a}throw t.isRollback()?t.reason:e}}async#r(s){try{return await this.getCollection(s)}catch(t){if(t.httpStatus===404)return null;throw t}}async#e(s,t,e){const a=await this.#s.request({method:s,path:t,data:e});return faas_common_sdk_1.ResponseUtil.handleResponse(a)}}exports.Database=Database;